<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN ‚Ä¢ FACTURAS ‚Äî KIWI Edition (B/W PRO)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- PDF -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <!-- QR -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <link rel="stylesheet" href="style.css" />
  <script defer src="app.js"></script>
</head>

<body class="bw-pro">
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="title">ARSLAN ‚Ä¢ FACTURAS</div>
        <div class="subtitle">KIWI Edition ¬∑ B/W ¬∑ Offline + Cloud opcional</div>
      </div>
    </div>

    <div class="actions">
      <div class="pill" id="pillMode">Modo local</div>

      <button class="btn" id="btnSync" title="Sincronizar nube (si est√° configurada)">Sync</button>
      <button class="btn" id="btnLogin" title="Login nube (opcional)">Cloud</button>

      <button class="btn" id="btnExport">Export</button>
      <button class="btn" id="btnImport">Import</button>
      <input id="fileImport" type="file" accept="application/json" hidden />
    </div>
  </header>

  <!-- TABS -->
  <nav class="tabs">
    <button class="tab active" data-tab="factura">Factura</button>
    <button class="tab" data-tab="facturas">Facturas</button>
    <button class="tab" data-tab="clientes">Clientes</button>
    <button class="tab" data-tab="productos">Productos</button>
    <button class="tab" data-tab="contabilidad">Contabilidad üîí</button>
    <button class="tab" data-tab="ajustes">Ajustes</button>
  </nav>

  <main class="container">

    <!-- =======================================================
         TAB: FACTURA (pantalla principal)
    ======================================================== -->
    <section id="tab-factura" class="tabpage show">

      <div class="invoice-head">
        <!-- Proveedor -->
        <div class="card">
          <div class="card-title">Proveedor</div>
          <div class="form">
            <label>Nombre</label>
            <input id="provName" type="text" placeholder="Proveedor" />

            <label>NIF</label>
            <input id="provNif" type="text" placeholder="NIF" />

            <label>Direcci√≥n</label>
            <input id="provAddr" type="text" placeholder="Direcci√≥n" />

            <label>Tel√©fono</label>
            <input id="provPhone" type="text" placeholder="Tel√©fono" />

            <label>Email</label>
            <input id="provEmail" type="text" placeholder="Email" />

            <button class="btn primary" id="btnSaveProvider">Guardar proveedor</button>
          </div>
        </div>

        <!-- QR -->
        <div class="card qrCard">
          <div class="card-title">QR AEAT</div>
          <div class="qrWrap">
            <div id="qrBox" class="qrBox"></div>
          </div>
          <div class="hint" id="qrHint">Se genera con NIF + N¬∫ factura + fecha + total.</div>
          <div class="row2">
            <button class="btn" id="btnRegenQR">Regenerar QR</button>
            <button class="btn" id="btnCopyQR">Copiar texto QR</button>
          </div>
        </div>

        <!-- Cliente -->
        <div class="card">
          <div class="card-title">Cliente</div>
          <div class="form">
            <label>Seleccionar cliente</label>
            <select id="invClient"></select>

            <label>Nombre fiscal / comercial</label>
            <input id="cliName" type="text" placeholder="Nombre cliente" />

            <label>NIF/CIF</label>
            <input id="cliNif" type="text" placeholder="NIF/CIF" />

            <label>Direcci√≥n</label>
            <input id="cliAddr" type="text" placeholder="Direcci√≥n" />

            <label>Tel√©fono</label>
            <input id="cliPhone" type="text" placeholder="Tel√©fono" />

            <label>Email</label>
            <input id="cliEmail" type="text" placeholder="Email" />

            <div class="row2">
              <button class="btn" id="btnNewClientInline">Nuevo cliente</button>
              <button class="btn" id="btnSaveClientInline">Guardar cliente</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Meta factura -->
      <div class="card">
        <div class="metaGrid">
          <div>
            <div class="label">N¬∫ factura</div>
            <input id="invNumber" type="text" />
          </div>

          <div>
            <div class="label">Fecha</div>
            <input id="invDate" type="date" />
          </div>

          <div>
            <div class="label">Tags (opcional)</div>
            <input id="invTags" type="text" placeholder="Ej: Braseros Centro, Riviera..." />
          </div>

          <div>
            <div class="label">Notas (internas)</div>
            <input id="invNotes" type="text" placeholder="Observaciones internas / pago / etc." />
          </div>
        </div>

        <div class="toolbar">
          <div class="left">
            <button class="btn" id="btnNewInvoice">+ Nueva</button>
            <button class="btn" id="btnDupInvoice">Duplicar</button>
            <button class="btn danger" id="btnDelInvoice">Eliminar</button>
          </div>

          <div class="right">
            <button class="btn primary" id="btnSaveInvoice">Guardar</button>
            <button class="btn" id="btnPDF">Generar PDF</button>
            <button class="btn" id="btnPDFCloud" title="Subir PDF a nube (si hay login)">PDF + Nube</button>
            <button class="btn" id="btnWhats">WhatsApp</button>
          </div>
        </div>
      </div>

      <!-- Cuadro de c√°lculo -->
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">Cuadro de c√°lculo</div>
            <div class="hint">GRID PRO ¬∑ 1 fila por producto ¬∑ sin scroll horizontal (PC)</div>
          </div>
          <div class="row2">
            <button class="btn primary" id="btnAddLine">+ A√±adir l√≠nea</button>
            <button class="btn" id="btnClearLines">Vaciar</button>
          </div>
        </div>

        <div class="gridTable">
          <div class="gridHead">
            <div>Producto</div>
            <div>Modo</div>
            <div>Cant.</div>
            <div>Bruto (kg)</div>
            <div>Tara (kg)</div>
            <div>Neto (kg)</div>
            <div>Precio</div>
            <div>Origen</div>
            <div>Importe</div>
            <div></div>
          </div>

          <div id="linesBody" class="gridBody">
            <!-- filas din√°micas -->
          </div>
        </div>

        <div class="hint" id="priceHintGlobal">
          Nota: ‚Äú√öltimos precios‚Äù solo se muestran en pantalla (no se imprimen en factura ni PDF).
        </div>
      </div>

      <!-- Totales / Pagos / Observaciones -->
      <div class="bottom3">
        <div class="card">
          <div class="card-title">Totales factura</div>

          <label class="checkline">
            <input id="chkTransport" type="checkbox" />
            <span>A√±adir transporte 10%</span>
          </label>

          <label class="checkline">
            <input id="chkIvaIncluido" type="checkbox" />
            <span>IVA 4% incluido (sin desglose)</span>
          </label>

          <div class="totals">
            <div class="row"><span>Subtotal</span><strong id="tSubtotal">0,00 ‚Ç¨</strong></div>
            <div class="row"><span>Transporte</span><strong id="tTransport">0,00 ‚Ç¨</strong></div>
            <div class="row"><span>IVA (4%)</span><strong id="tIva">0,00 ‚Ç¨</strong></div>
            <div class="row big"><span>TOTAL</span><strong id="tTotal">0,00 ‚Ç¨</strong></div>
          </div>

          <button class="btn" id="btnAddIvaToTotal">+ A√±adir 4% IVA al total</button>
        </div>

        <div class="card">
          <div class="card-title">Pagos</div>

          <label>Importe parcial</label>
          <input id="payAmount" type="number" inputmode="decimal" placeholder="0.00" />
          <button class="btn primary" id="btnAddPay">+ A√±adir pago</button>

          <div class="hint" id="payListHint">Sin pagos parciales.</div>
          <div id="payList" class="payList"></div>

          <label>Pagado manual (opcional)</label>
          <input id="payManual" type="number" inputmode="decimal" placeholder="0.00" />

          <label>Estado</label>
          <select id="payStatus">
            <option value="impagada">Impagada</option>
            <option value="parcial">Parcial</option>
            <option value="pagada">Pagada</option>
          </select>

          <label>M√©todo</label>
          <select id="payMethod">
            <option value="efectivo">Efectivo</option>
            <option value="transferencia">Transferencia</option>
            <option value="tarjeta">Tarjeta</option>
          </select>

          <div class="row big">
            <span>Pendiente:</span>
            <strong id="tPending">0,00 ‚Ç¨</strong>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Observaciones</div>
          <textarea id="invObs" rows="10" placeholder="Notas, condiciones, etc."></textarea>
        </div>
      </div>

      <!-- Vista previa ‚ÄúFactura final‚Äù -->
      <div class="card previewCard">
        <div class="card-title-row">
          <div>
            <div class="card-title">Factura final (vista previa)</div>
            <div class="hint">Lo que ves aqu√≠ se refleja en el PDF.</div>
          </div>
          <div class="row2">
            <button class="btn" id="btnOpenPDF">Abrir PDF</button>
            <button class="btn" id="btnCopyPDF">Copiar link PDF (si nube)</button>
            <div class="pill" id="pdfState">‚Äî</div>
          </div>
        </div>

        <div id="invoicePreview" class="invoicePreview">
          <!-- render din√°mico -->
        </div>
      </div>
    </section>

    <!-- =======================================================
         TAB: FACTURAS (listado)
    ======================================================== -->
    <section id="tab-facturas" class="tabpage">
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">Listado de facturas</div>
            <div class="hint">Click para abrir en ‚ÄúFactura‚Äù.</div>
          </div>
          <div class="row2">
            <input id="invSearch" type="text" placeholder="Buscar por n¬∫, cliente, tag..." />
            <button class="btn" id="btnClearInvSearch">Limpiar</button>
          </div>
        </div>

        <div id="invoiceList" class="list"></div>
      </div>
    </section>

    <!-- =======================================================
         TAB: CLIENTES
    ======================================================== -->
    <section id="tab-clientes" class="tabpage">
      <div class="twoCols">
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">Clientes</div>
              <div class="hint">Alta / edici√≥n / b√∫squeda.</div>
            </div>
            <div class="row2">
              <input id="cliSearch" type="text" placeholder="Buscar cliente..." />
              <button class="btn" id="btnNewClient">+ Nuevo</button>
            </div>
          </div>
          <div id="clientList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-title">Editar cliente</div>
          <div class="form">
            <input id="cliId" type="text" hidden />

            <label>Nombre fiscal</label>
            <input id="cliEditName" type="text" />

            <label>Alias / Comercial (opcional)</label>
            <input id="cliEditAlias" type="text" />

            <label>NIF/CIF</label>
            <input id="cliEditNif" type="text" />

            <label>Direcci√≥n</label>
            <input id="cliEditAddr" type="text" />

            <label>Tel√©fono</label>
            <input id="cliEditPhone" type="text" />

            <label>Email</label>
            <input id="cliEditEmail" type="text" />

            <label>Notas</label>
            <textarea id="cliEditNotes" rows="5"></textarea>

            <div class="toolbar">
              <div class="left">
                <button class="btn danger" id="btnDelClient">Eliminar</button>
              </div>
              <div class="right">
                <button class="btn primary" id="btnSaveClient">Guardar</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =======================================================
         TAB: PRODUCTOS
    ======================================================== -->
    <section id="tab-productos" class="tabpage">
      <div class="twoCols">
        <div class="card">
          <div class="card-title-row">
            <div>
              <div class="card-title">Productos</div>
              <div class="hint">Precios + kg/caja + historial (√∫ltimas 5).</div>
            </div>
            <div class="row2">
              <input id="prodSearch" type="text" placeholder="Buscar producto..." />
              <button class="btn" id="btnNewProd">+ Nuevo</button>
            </div>
          </div>
          <div id="productList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-title">Editar producto</div>
          <div class="form">
            <input id="prodKey" type="text" hidden />

            <label>Nombre</label>
            <input id="prodName" type="text" />

            <label>Modo por defecto</label>
            <select id="prodMode">
              <option value="kg">kg</option>
              <option value="caja">caja</option>
              <option value="ud">ud</option>
            </select>

            <label>Kg por caja (si aplica)</label>
            <input id="prodKgBox" type="number" inputmode="decimal" placeholder="Ej: 22" />

            <label>Precio ‚Ç¨/kg</label>
            <input id="prodPriceKg" type="number" inputmode="decimal" placeholder="0.00" />

            <label>Precio ‚Ç¨/caja</label>
            <input id="prodPriceBox" type="number" inputmode="decimal" placeholder="0.00" />

            <label>Precio ‚Ç¨/ud</label>
            <input id="prodPriceUd" type="number" inputmode="decimal" placeholder="0.00" />

            <label>Coste (opcional, para margen) ‚Ç¨/kg o ‚Ç¨/ud</label>
            <input id="prodCost" type="number" inputmode="decimal" placeholder="0.00" />

            <label>Origen por defecto (opcional)</label>
            <input id="prodOrigin" type="text" placeholder="Ej: Espa√±a, Marruecos..." />

            <div class="historyBox">
              <div class="card-title mini">Historial (√∫ltimas 5)</div>
              <div id="prodHistory" class="history"></div>
              <div class="hint">El historial solo se muestra en pantalla (no se imprime).</div>
            </div>

            <div class="toolbar">
              <div class="left">
                <button class="btn danger" id="btnDelProd">Eliminar</button>
              </div>
              <div class="right">
                <button class="btn primary" id="btnSaveProd">Guardar</button>
              </div>
            </div>

          </div>
        </div>
      </div>
    </section>

    <!-- =======================================================
         TAB: CONTABILIDAD (PIN)
    ======================================================== -->
    <section id="tab-contabilidad" class="tabpage">
      <div class="card">
        <div class="card-title-row">
          <div>
            <div class="card-title">Contabilidad</div>
            <div class="hint">Bloqueada por PIN. Facturas siempre libre.</div>
          </div>
          <div class="row2">
            <div class="pill" id="accStatus">Bloqueado</div>
            <button class="btn" id="btnUnlock">Desbloquear</button>
            <button class="btn" id="btnLock">Bloquear</button>
          </div>
        </div>

        <div class="metaGrid">
          <div>
            <div class="label">Desde</div>
            <input id="accFrom" type="date" />
          </div>
          <div>
            <div class="label">Hasta</div>
            <input id="accTo" type="date" />
          </div>
          <div>
            <div class="label">Cliente</div>
            <select id="accClient"></select>
          </div>
          <div>
            <div class="label">Tag</div>
            <input id="accTag" type="text" placeholder="Ej: Riviera" />
          </div>
        </div>

        <div class="toolbar">
          <div class="left"></div>
          <div class="right">
            <button class="btn primary" id="btnAccRun">Calcular</button>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="k">Ventas</div><div class="v" id="accSales">0,00 ‚Ç¨</div></div>
          <div class="kpi"><div class="k">IVA</div><div class="v" id="accIva">0,00 ‚Ç¨</div></div>
          <div class="kpi"><div class="k">Facturas</div><div class="v" id="accN">0</div></div>
          <div class="kpi"><div class="k">Margen</div><div class="v" id="accMargin">0,00 ‚Ç¨</div></div>
        </div>

        <div class="tableWrap">
          <table class="table" id="accTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>N¬∫</th>
                <th>Cliente</th>
                <th>Total</th>
                <th>Tags</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="muted">Contabilidad bloqueada. Pulsa ‚ÄúDesbloquear‚Äù.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =======================================================
         TAB: AJUSTES
    ======================================================== -->
    <section id="tab-ajustes" class="tabpage">
      <div class="twoCols">
        <div class="card">
          <div class="card-title">Ajustes generales</div>

          <label>PIN contabilidad (admin)</label>
          <input id="setPin" type="password" placeholder="Ej: 7392" />

          <label>IVA (%)</label>
          <input id="setTax" type="number" inputmode="decimal" placeholder="4" />

          <label>Transporte (%)</label>
          <input id="setTransport" type="number" inputmode="decimal" placeholder="10" />

          <label>Plantilla QR AEAT</label>
          <input id="setQrBase" type="text" />

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn primary" id="btnSaveSettings">Guardar ajustes</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">Cloud (Firebase) ‚Äî opcional</div>
          <div class="hint">Si no lo rellenas, todo funciona en modo local. 0 errores.</div>

          <label>apiKey</label>
          <input id="fbApiKey" type="text" />

          <label>authDomain</label>
          <input id="fbAuthDomain" type="text" />

          <label>databaseURL</label>
          <input id="fbDbURL" type="text" />

          <label>projectId</label>
          <input id="fbProjectId" type="text" />

          <label>appId</label>
          <input id="fbAppId" type="text" />

          <label>storageBucket</label>
          <input id="fbBucket" type="text" />

          <div class="toolbar">
            <div class="left"></div>
            <div class="right">
              <button class="btn primary" id="btnSaveFirebase">Guardar Firebase</button>
            </div>
          </div>

          <div class="hint" id="cloudMsg">‚Äî</div>
        </div>
      </div>
    </section>

  </main>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal" style="display:none;">
    <div class="modalCard">
      <div class="modalTitle">Cloud Login (opcional)</div>

      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="email" />

      <label>Password</label>
      <input id="loginPass" type="password" placeholder="password" />

      <div class="toolbar">
        <div class="left">
          <button class="btn" id="btnLoginClose">Cerrar</button>
        </div>
        <div class="right">
          <button class="btn" id="btnSignupDo">Crear cuenta</button>
          <button class="btn primary" id="btnLoginDo">Entrar</button>
          <button class="btn" id="btnLogout">Salir</button>
        </div>
      </div>

      <div class="hint" id="loginMsg">‚Äî</div>
    </div>
  </div>

  <!-- PIN MODAL -->
  <div class="modal" id="pinModal" style="display:none;">
    <div class="modalCard">
      <div class="modalTitle">PIN Contabilidad</div>
      <input id="pinInput" type="password" inputmode="numeric" placeholder="PIN" />
      <div class="toolbar">
        <div class="left"><button class="btn" id="btnPinCancel">Cancelar</button></div>
        <div class="right"><button class="btn primary" id="btnPinOk">OK</button></div>
      </div>
      <div class="hint" id="pinMsg">‚Äî</div>
    </div>
  </div>

</body>
</html>
