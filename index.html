<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN • FACTURAS — KIWI Edition (B/W PRO)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- QR (pantalla + export a PNG para PDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- LZ-String (link de precios comprimido opcional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>

  <script defer src="./app.js"></script>
</head>

<body class="bw-pro">
  <header class="topbar">
    <div class="brand">
      <div class="logo-dot"></div>
      <div class="brand-text">
        <div class="brand-title">ARSLAN • FACTURAS</div>
        <div class="brand-sub">KIWI Edition — B/W PRO</div>
      </div>
    </div>

    <nav class="tabs" id="tabs">
      <button class="tab active" data-view="facturas">Facturas</button>
      <button class="tab" data-view="clientes">Clientes</button>
      <button class="tab" data-view="productos">Productos</button>
      <button class="tab" data-view="contabilidad">Contabilidad</button>
      <button class="tab" data-view="ajustes">Ajustes</button>
    </nav>

    <div class="cloud">
      <span class="pill" id="cloudPill">Modo local</span>
      <button class="btn ghost" id="btnCloudLogin">Cloud</button>
      <button class="btn ghost" id="btnSync" title="Sincroniza (merge inteligente) con nube" disabled>Sync</button>
    </div>
  </header>

  <main class="main">
    <!-- =========================
         VIEW: FACTURAS (FULL)
    ========================== -->
    <section class="view active" id="view-facturas">
      <div class="facturas-layout">

        <!-- Left: listado facturas -->
        <aside class="side">
          <div class="side-head">
            <div>
              <div class="h2">Facturas</div>
              <div class="muted">Listado + buscador</div>
            </div>
            <button class="btn primary" id="btnNewInvoice">+ Nueva</button>
          </div>

          <div class="side-tools">
            <input class="inp" id="invSearch" placeholder="Buscar: nº / cliente / tag…" />
            <div class="row">
              <button class="btn" id="btnExportJSON">Export JSON</button>
              <label class="btn">
                Import JSON
                <input type="file" id="fileImportJSON" accept="application/json" hidden />
              </label>
            </div>
          </div>

          <div class="inv-list" id="invList"></div>
        </aside>

        <!-- Right: editor factura -->
        <section class="editor">
          <div class="editor-top">
            <div class="meta-row">
              <div class="meta">
                <div class="meta-item">
                  <div class="lbl">Nº factura</div>
                  <input class="inp" id="invNumber" placeholder="FA-YYYYMMDDHHMM" />
                </div>
                <div class="meta-item">
                  <div class="lbl">Fecha</div>
                  <input class="inp" id="invDate" type="date" />
                </div>
                <div class="meta-item">
                  <div class="lbl">Tags</div>
                  <input class="inp" id="invTags" placeholder="ej: Riviera / Braseros Centro…" />
                </div>
              </div>

              <div class="meta-actions">
                <button class="btn" id="btnDuplicate">Duplicar</button>
                <button class="btn danger" id="btnDelete">Eliminar</button>
              </div>
            </div>

            <!-- 3 columnas: proveedor | QR | cliente -->
            <div class="triple">
              <div class="card box">
                <div class="box-title">Proveedor (izquierda)</div>
                <div class="grid2">
                  <div>
                    <div class="lbl">Nombre</div>
                    <input class="inp" id="provName" />
                  </div>
                  <div>
                    <div class="lbl">NIF</div>
                    <input class="inp" id="provNIF" />
                  </div>
                  <div class="span2">
                    <div class="lbl">Dirección</div>
                    <input class="inp" id="provAddr" />
                  </div>
                  <div>
                    <div class="lbl">Teléfono</div>
                    <input class="inp" id="provPhone" />
                  </div>
                  <div>
                    <div class="lbl">Email</div>
                    <input class="inp" id="provEmail" />
                  </div>
                </div>
              </div>

              <div class="card box center">
                <div class="box-title">QR AEAT (centro)</div>
                <div class="qrwrap">
                  <div id="qrBox" class="qrbox"></div>
                  <div class="muted small" id="qrTextMini">—</div>
                </div>
              </div>

              <div class="card box">
                <div class="box-title">Cliente (derecha)</div>
                <div class="grid2">
                  <div class="span2">
                    <div class="lbl">Seleccionar cliente</div>
                    <select class="inp" id="clientSelect"></select>
                  </div>
                  <div class="span2">
                    <div class="lbl">Nombre fiscal</div>
                    <input class="inp" id="cliName" />
                  </div>
                  <div>
                    <div class="lbl">NIF/CIF</div>
                    <input class="inp" id="cliNIF" />
                  </div>
                  <div>
                    <div class="lbl">Teléfono</div>
                    <input class="inp" id="cliPhone" />
                  </div>
                  <div class="span2">
                    <div class="lbl">Dirección</div>
                    <input class="inp" id="cliAddr" />
                  </div>
                </div>
              </div>
            </div>

            <div class="notes-row">
              <div class="grow">
                <div class="lbl">Observaciones</div>
                <textarea class="inp area" id="invNotes" rows="2" placeholder="Notas internas / condiciones…"></textarea>
              </div>
              <div class="hintbox">
                <div class="lbl">Estado</div>
                <div class="row">
                  <select class="inp" id="invStatus">
                    <option value="impagada">Impagada</option>
                    <option value="parcial">Parcial</option>
                    <option value="pagada">Pagada</option>
                  </select>
                  <select class="inp" id="invPayMethod">
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                  </select>
                </div>
                <div class="muted small" id="lastSaved">—</div>
              </div>
            </div>
          </div>

          <!-- GRID PRO líneas -->
          <div class="card table-card">
            <div class="table-head">
              <div class="h2">Cuadro de cálculo</div>
              <div class="row">
                <button class="btn" id="btnAdd5">+ 5 líneas</button>
                <button class="btn primary" id="btnAddLine">+ Línea</button>
                <button class="btn" id="btnClearLines">Vaciar</button>
              </div>
            </div>

            <div class="lines-header" id="linesHeader">
              <div>Producto</div>
              <div>Modo</div>
              <div>Cant</div>
              <div>Kg/Bruto</div>
              <div>Tara</div>
              <div>Neto</div>
              <div>Precio</div>
              <div>Origen</div>
              <div>Importe</div>
              <div></div>
            </div>

            <div class="lines" id="lines"></div>

            <div class="muted small pad" id="priceHint">Últimos precios: solo pantalla (NO se imprimen)</div>
          </div>

          <!-- Cards abajo -->
          <div class="bottom-grid">
            <div class="card pad">
              <div class="h2">Totales</div>
              <div class="totals">
                <div class="trow"><span class="muted">Subtotal</span><strong id="tSubtotal">0,00 €</strong></div>
                <div class="trow">
                  <span class="muted">Transporte</span>
                  <div class="row tight">
                    <label class="check"><input type="checkbox" id="chkTransport" /> <span>Aplicar</span></label>
                    <input class="inp mini" id="transportPct" type="number" step="0.1" min="0" value="10" />
                    <span class="muted">%</span>
                    <strong id="tTransport">0,00 €</strong>
                  </div>
                </div>
                <div class="trow">
                  <span class="muted">IVA</span>
                  <div class="row tight">
                    <label class="check"><input type="checkbox" id="chkIvaIncluded" /> <span>IVA incluido (sin desglose)</span></label>
                    <input class="inp mini" id="ivaRate" type="number" step="0.01" min="0" value="4" />
                    <span class="muted">%</span>
                    <strong id="tIVA">0,00 €</strong>
                  </div>
                </div>
                <div class="trow big"><span>TOTAL</span><strong id="tTotal">0,00 €</strong></div>
              </div>
            </div>

            <div class="card pad">
              <div class="h2">Pagos</div>
              <div class="row">
                <input class="inp" id="payAmount" type="number" step="0.01" placeholder="Importe pago" />
                <button class="btn primary" id="btnAddPay">Añadir</button>
              </div>
              <div class="muted small">Pagos parciales guardados en factura</div>
              <div class="pay-list" id="payList"></div>
              <div class="trow big"><span>Pendiente</span><strong id="tDue">0,00 €</strong></div>
            </div>

            <div class="card pad">
              <div class="h2">Acciones</div>
              <div class="stack">
                <button class="btn primary" id="btnSave">Guardar</button>
                <button class="btn" id="btnPDF">Generar PDF</button>
                <button class="btn" id="btnPDFCloud" title="Guardar PDF en nube (si hay Cloud)" disabled>PDF + Nube</button>
                <div class="row">
                  <button class="btn" id="btnOpenPdf" disabled>Ver PDF</button>
                  <button class="btn" id="btnCopyPdf" disabled>Copiar link</button>
                </div>
                <button class="btn" id="btnWhats">WhatsApp TXT</button>
                <div class="muted small" id="pdfState">PDF —</div>
              </div>
            </div>
          </div>

        </section>
      </div>
    </section>

    <!-- =========================
         VIEW: CLIENTES
    ========================== -->
    <section class="view" id="view-clientes">
      <div class="view-head">
        <div>
          <div class="h1">Clientes</div>
          <div class="muted">Alta / edición / búsqueda</div>
        </div>
        <button class="btn primary" id="btnNewClient">+ Añadir cliente</button>
      </div>

      <div class="card pad">
        <div class="row">
          <input class="inp grow" id="clientSearch" placeholder="Buscar cliente…" />
        </div>
        <div class="clients-grid" id="clientsGrid"></div>
      </div>
    </section>

    <!-- =========================
         VIEW: PRODUCTOS
    ========================== -->
    <section class="view" id="view-productos">
      <div class="view-head">
        <div>
          <div class="h1">Productos</div>
          <div class="muted">Precios + kg/caja + historial (últimas 5)</div>
        </div>
        <div class="row">
          <button class="btn" id="btnImportPricesLink">Importar precios (link)</button>
          <button class="btn primary" id="btnRebuildVocab">Recargar vocabulario</button>
        </div>
      </div>

      <div class="card pad">
        <div class="row">
          <input class="inp grow" id="prodSearch" placeholder="Buscar producto…" />
          <select class="inp" id="unitFilter">
            <option value="">Todos</option>
            <option value="kg">kg</option>
            <option value="caja">caja</option>
            <option value="unidad">unidad</option>
          </select>
        </div>

        <div class="muted small">
          Consejo: El precio que veas “Último” es solo pantalla. El PDF imprime solo el precio actual de la línea.
        </div>

        <div class="products-grid" id="productsGrid"></div>
      </div>
    </section>

    <!-- =========================
         VIEW: CONTABILIDAD (PIN)
    ========================== -->
    <section class="view" id="view-contabilidad">
      <div class="view-head">
        <div>
          <div class="h1">Contabilidad</div>
          <div class="muted">Protegida por PIN (Facturas queda libre)</div>
        </div>
        <div class="row">
          <button class="btn" id="btnUnlock">Desbloquear</button>
          <button class="btn" id="btnLock">Bloquear</button>
          <span class="pill" id="accStatus">Bloqueado</span>
        </div>
      </div>

      <div class="card pad">
        <div class="row">
          <input class="inp" id="accFrom" type="date" />
          <input class="inp" id="accTo" type="date" />
          <select class="inp" id="accClient"></select>
          <input class="inp" id="accTag" placeholder="Filtrar tag (opcional)" />
          <button class="btn primary" id="btnAccRun" disabled>Calcular</button>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="muted">Ventas</div><div class="kpiV" id="accSales">0,00 €</div></div>
          <div class="kpi"><div class="muted">IVA</div><div class="kpiV" id="accIva">0,00 €</div></div>
          <div class="kpi"><div class="muted">Facturas</div><div class="kpiV" id="accN">0</div></div>
          <div class="kpi"><div class="muted">Margen est.</div><div class="kpiV" id="accMargin">0,00 €</div></div>
        </div>

        <div class="table">
          <table id="accTable">
            <thead>
              <tr>
                <th>Fecha</th><th>Nº</th><th>Cliente</th><th>Total</th><th>Tags</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="5" class="muted">Contabilidad bloqueada. Pulsa “Desbloquear”.</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- =========================
         VIEW: AJUSTES
    ========================== -->
    <section class="view" id="view-ajustes">
      <div class="view-head">
        <div>
          <div class="h1">Ajustes</div>
          <div class="muted">IVA 4% · QR AEAT · PIN · Firebase</div>
        </div>
        <button class="btn primary" id="btnSaveSettings">Guardar ajustes</button>
      </div>

      <div class="grid-2">
        <div class="card pad">
          <div class="h2">Impuestos / QR</div>
          <div class="grid2">
            <div>
              <div class="lbl">IVA (%)</div>
              <input class="inp" id="setIvaRate" type="number" step="0.01" value="4" />
            </div>
            <div>
              <div class="lbl">Transporte (%)</div>
              <input class="inp" id="setTransportPct" type="number" step="0.1" value="10" />
            </div>
            <div class="span2">
              <div class="lbl">Plantilla QR AEAT</div>
              <input class="inp" id="setQrTpl" />
              <div class="muted small">Variables: {NIF} {NUM} {FECHA} {TOTAL}</div>
            </div>
            <div class="span2">
              <div class="lbl">Logo (texto)</div>
              <input class="inp" id="setLogoText" placeholder="ARSLAN" />
              <div class="muted small">Se imprime como logo en el PDF (B/W PRO).</div>
            </div>
          </div>
        </div>

        <div class="card pad">
          <div class="h2">Seguridad</div>
          <div class="grid2">
            <div class="span2">
              <div class="lbl">PIN contabilidad</div>
              <input class="inp" id="setPin" placeholder="7392" />
            </div>
          </div>
        </div>

        <div class="card pad">
          <div class="h2">Firebase (opcional)</div>
          <div class="muted small">Si no lo rellenas, todo funciona en modo local.</div>
          <div class="lbl">Config JSON (apiKey, authDomain, databaseURL, projectId, appId, storageBucket)</div>
          <textarea class="inp area" id="setFirebaseJson" rows="8" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","appId":"...","storageBucket":"..."}'></textarea>
          <div class="row">
            <button class="btn" id="btnReloadCloud">Recargar Cloud</button>
            <a class="btn" href="./prices.html" target="_blank" rel="noopener">Abrir “Poner Precios”</a>
          </div>
          <div class="muted small">Para guardar PDFs en nube hace falta storageBucket.</div>
        </div>

        <div class="card pad">
          <div class="h2">Mantenimiento</div>
          <div class="row">
            <button class="btn danger" id="btnResetAll">Reset total (local)</button>
          </div>
          <div class="muted small">No borra la nube. Solo tu localStorage.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- =========================
       MODAL: Cloud Login
  ========================== -->
  <div class="modal" id="loginModal" style="display:none">
    <div class="modal-card">
      <div class="modal-head">
        <div class="h2">Cloud</div>
        <button class="btn" id="btnLoginClose">Cerrar</button>
      </div>
      <div class="grid2">
        <div class="span2">
          <div class="lbl">Email</div>
          <input class="inp" id="loginEmail" type="email" />
        </div>
        <div class="span2">
          <div class="lbl">Password</div>
          <input class="inp" id="loginPass" type="password" />
        </div>
      </div>
      <div class="row">
        <button class="btn primary" id="btnLoginDo">Entrar</button>
        <button class="btn" id="btnSignupDo">Crear cuenta</button>
        <button class="btn" id="btnLogout">Salir</button>
      </div>
      <div class="muted small" id="loginMsg">—</div>
    </div>
  </div>

  <!-- =========================
       MODAL: PIN
  ========================== -->
  <div class="modal" id="pinModal" style="display:none">
    <div class="modal-card">
      <div class="modal-head">
        <div class="h2">PIN Contabilidad</div>
        <button class="btn" id="btnPinClose">Cerrar</button>
      </div>
      <div class="lbl">Introduce PIN</div>
      <input class="inp" id="pinInput" type="password" />
      <div class="row">
        <button class="btn primary" id="btnPinOk">OK</button>
      </div>
      <div class="muted small" id="pinMsg">—</div>
    </div>
  </div>

</body>
</html>
