<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN • FACTURAS — KIWI EDITION</title>
  <link rel="stylesheet" href="./style.css" />

  <!-- Optional libs (si no cargan, el sistema sigue) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand__mark">KIWI</div>
      <div class="brand__text">
        <div class="brand__title">ARSLAN • FACTURAS</div>
        <div class="brand__subtitle">KIWI EDITION — B/W + Offline + Cloud</div>
      </div>
    </div>

    <div class="topbar__right">
      <div id="cloudBadge" class="badge">Modo local</div>
      <button id="btnSync" class="btn btn--ghost" title="Sync manual">Sync ahora</button>
      <button id="btnLogin" class="btn btn--ghost">Login</button>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab is-active" data-tab="invoices">Facturas</button>
    <button class="tab" data-tab="clients">Clientes</button>
    <button class="tab" data-tab="products">Productos</button>
    <button class="tab" data-tab="accounting">Contabilidad</button>
    <button class="tab" data-tab="settings">Ajustes</button>
  </nav>

  <main class="wrap">
    <!-- FACTURAS -->
    <section id="tab-invoices" class="panel is-active">
      <div class="row row--split">
        <div class="row__left">
          <div class="h1">Facturas</div>
          <div class="muted">Buscar por número / cliente / tag</div>
        </div>
        <div class="row__right">
          <input id="invSearch" class="input" placeholder="Buscar…" />
          <button id="btnNewInvoice" class="btn">Nueva factura</button>
        </div>
      </div>

      <div class="card">
        <div id="invoiceList" class="list"></div>
      </div>

      <div id="editor" class="editor hidden">
        <div class="editor__top">
          <div class="editor__actions">
            <button id="btnBack" class="btn btn--ghost">← Volver</button>
            <div class="spacer"></div>
            <button id="btnDuplicate" class="btn btn--ghost">Duplicar</button>
            <button id="btnDelete" class="btn btn--danger">Eliminar</button>
            <button id="btnSave" class="btn">Guardar</button>
          </div>

          <div class="editor__header">
            <div class="box">
              <div class="box__title">Proveedor</div>
              <div class="grid2">
                <label class="field"><span>Nombre</span><input id="provName" class="input" /></label>
                <label class="field"><span>NIF</span><input id="provNif" class="input" /></label>
                <label class="field"><span>Dirección</span><input id="provAddr" class="input" /></label>
                <label class="field"><span>Teléfono</span><input id="provPhone" class="input" /></label>
                <label class="field"><span>Email</span><input id="provEmail" class="input" /></label>
              </div>
            </div>

            <div class="qrbox">
              <div class="box__title center">QR</div>
              <div class="qrwrap">
                <canvas id="qrCanvas" width="160" height="160"></canvas>
              </div>
              <div id="qrHint" class="muted center small"></div>
            </div>

            <div class="box">
              <div class="box__title">Cliente</div>
              <div class="grid2">
                <label class="field col2">
                  <span>Seleccionar</span>
                  <select id="invClient" class="input"></select>
                </label>
                <label class="field"><span>Nombre fiscal / Alias</span><input id="cliName" class="input" disabled /></label>
                <label class="field"><span>NIF/CIF</span><input id="cliNif" class="input" disabled /></label>
                <label class="field col2"><span>Dirección</span><input id="cliAddr" class="input" disabled /></label>
                <label class="field"><span>Email</span><input id="cliEmail" class="input" disabled /></label>
                <label class="field"><span>Teléfono</span><input id="cliPhone" class="input" disabled /></label>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="grid4">
              <label class="field"><span>Nº factura</span><input id="invNumber" class="input" disabled /></label>
              <label class="field"><span>Fecha</span><input id="invDate" class="input" type="date" /></label>
              <label class="field"><span>Tags</span><input id="invTags" class="input" placeholder="ej: Centro, Riviera…" /></label>
              <label class="field"><span>Método</span>
                <select id="invMethod" class="input">
                  <option value="Efectivo">Efectivo</option>
                  <option value="Transferencia">Transferencia</option>
                  <option value="Tarjeta">Tarjeta</option>
                </select>
              </label>

              <label class="field"><span>IVA</span>
                <select id="invVatMode" class="input">
                  <option value="breakdown">Desglosado (Subtotal + IVA)</option>
                  <option value="included">IVA incluido en precios (sin desglose)</option>
                </select>
              </label>

              <label class="field"><span>Transporte</span>
                <div class="inline">
                  <label class="chip"><input id="invTransportOn" type="checkbox" /> Activar</label>
                  <input id="invTransportPct" class="input" type="number" step="0.01" min="0" style="width:120px" />
                </div>
              </label>

              <div class="field">
                <span>Estado</span>
                <div id="invStatus" class="badge">Impagada</div>
              </div>

              <div class="field">
                <span>PDF</span>
                <div class="inline">
                  <button id="btnPdf" class="btn btn--ghost">Generar PDF</button>
                  <button id="btnOpenPdf" class="btn btn--ghost">Abrir PDF</button>
                  <button id="btnCopyPdf" class="btn btn--ghost">Copiar link</button>
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="row row--split">
              <div class="row__left">
                <div class="h2">Cuadro de cálculo</div>
                <div class="muted">Enter → siguiente campo. Autocomplete con ↑ ↓ + Enter.</div>
              </div>
              <div class="row__right">
                <button id="btnAddLine" class="btn btn--ghost">+ Añadir línea</button>
                <button id="btnClearLines" class="btn btn--ghost">Vaciar</button>
              </div>
            </div>

            <div class="gridpro">
              <div class="gridpro__head">
                <div>Producto</div><div>Modo</div><div>Cant</div><div>Bruto</div><div>Tara</div><div>Neto</div><div>Precio</div><div>Origen</div><div>Importe</div><div></div>
              </div>
              <div id="lines" class="gridpro__body"></div>
            </div>
          </div>

          <div class="grid3">
            <div class="card">
              <div class="h2">Totales</div>
              <div class="totals">
                <div><span>Subtotal</span><strong id="tSubtotal">0,00</strong></div>
                <div><span>Transporte</span><strong id="tTransport">0,00</strong></div>
                <div><span>IVA</span><strong id="tVat">0,00</strong></div>
                <div class="totals__big"><span>Total</span><strong id="tTotal">0,00</strong></div>
                <div class="totals__big"><span>Pendiente</span><strong id="tDue">0,00</strong></div>
              </div>
            </div>

            <div class="card">
              <div class="row row--split">
                <div class="row__left">
                  <div class="h2">Pagos</div>
                  <div class="muted">Pagos parciales o manual.</div>
                </div>
              </div>

              <div class="grid2">
                <label class="field"><span>Importe</span><input id="payAmount" class="input" type="number" step="0.01" /></label>
                <label class="field"><span>Método</span>
                  <select id="payMethod" class="input">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Tarjeta">Tarjeta</option>
                  </select>
                </label>
                <label class="field col2"><span>Nota</span><input id="payNote" class="input" placeholder="opcional" /></label>
              </div>
              <div class="inline">
                <button id="btnAddPayment" class="btn btn--ghost">Añadir pago</button>
                <div class="spacer"></div>
                <label class="chip"><input id="paidManualOn" type="checkbox" /> Pagado manual</label>
                <input id="paidManualAmount" class="input" type="number" step="0.01" style="width:140px" placeholder="importe" />
              </div>

              <div id="paymentList" class="list list--compact"></div>
            </div>

            <div class="card">
              <div class="h2">Notas & WhatsApp</div>
              <label class="field"><span>Notas</span><textarea id="invNotes" class="textarea" rows="6" placeholder="Observaciones…"></textarea></label>
              <div class="inline">
                <button id="btnWhats" class="btn btn--ghost">Copiar WhatsApp TXT</button>
                <button id="btnWhatsPreview" class="btn btn--ghost">Ver TXT</button>
              </div>
              <pre id="whatsPreview" class="pre hidden"></pre>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- CLIENTES -->
    <section id="tab-clients" class="panel">
      <div class="row row--split">
        <div class="row__left">
          <div class="h1">Clientes</div>
          <div class="muted">Alta / edición / borrado. Tags opcionales.</div>
        </div>
        <div class="row__right">
          <input id="cliSearch" class="input" placeholder="Buscar cliente…" />
          <button id="btnNewClient" class="btn">Nuevo cliente</button>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div id="clientList" class="list"></div>
        </div>

        <div class="card">
          <div class="h2">Editor cliente</div>
          <div class="grid2">
            <label class="field"><span>ID</span><input id="cId" class="input" disabled /></label>
            <label class="field"><span>Alias</span><input id="cAlias" class="input" /></label>
            <label class="field col2"><span>Nombre fiscal</span><input id="cName" class="input" /></label>
            <label class="field"><span>NIF/CIF</span><input id="cNif" class="input" /></label>
            <label class="field"><span>Teléfono</span><input id="cPhone" class="input" /></label>
            <label class="field"><span>Email</span><input id="cEmail" class="input" /></label>
            <label class="field col2"><span>Dirección</span><input id="cAddr" class="input" /></label>
            <label class="field col2"><span>Tags</span><input id="cTags" class="input" placeholder="ej: Golden, Centro…" /></label>
            <label class="field col2"><span>IVA (override)</span>
              <select id="cVatMode" class="input">
                <option value="">(usar ajuste general)</option>
                <option value="breakdown">Desglosado</option>
                <option value="included">IVA incluido (sin desglose)</option>
              </select>
            </label>
          </div>
          <div class="inline">
            <button id="btnSaveClient" class="btn">Guardar</button>
            <button id="btnDeleteClient" class="btn btn--danger">Eliminar</button>
          </div>
          <div class="muted small">Si eliminas un cliente, sus facturas conservan el nombre cacheado.</div>
        </div>
      </div>
    </section>

    <!-- PRODUCTOS -->
    <section id="tab-products" class="panel">
      <div class="row row--split">
        <div class="row__left">
          <div class="h1">Productos</div>
          <div class="muted">Catálogo + unidad por defecto + kg/caja + precio + coste + origen + historial.</div>
        </div>
        <div class="row__right">
          <input id="prdSearch" class="input" placeholder="Buscar producto…" />
          <button id="btnNewProduct" class="btn">Nuevo producto</button>
        </div>
      </div>

      <div class="grid2">
        <div class="card">
          <div id="productList" class="list"></div>
        </div>

        <div class="card">
          <div class="h2">Editor producto</div>
          <div class="grid2">
            <label class="field"><span>ID</span><input id="pId" class="input" disabled /></label>
            <label class="field col2"><span>Nombre</span><input id="pName" class="input" /></label>
            <label class="field"><span>Unidad por defecto</span>
              <select id="pUnit" class="input">
                <option value="kg">kg</option>
                <option value="box">caja</option>
                <option value="unit">unidad</option>
              </select>
            </label>
            <label class="field"><span>Kg/caja</span><input id="pKgBox" class="input" type="number" step="0.01" /></label>
            <label class="field"><span>Precio actual</span><input id="pPrice" class="input" type="number" step="0.01" /></label>
            <label class="field"><span>Coste</span><input id="pCost" class="input" type="number" step="0.01" /></label>
            <label class="field col2"><span>Origen por defecto</span><input id="pOrigin" class="input" /></label>
          </div>

          <div class="inline">
            <button id="btnSaveProduct" class="btn">Guardar</button>
            <button id="btnDeleteProduct" class="btn btn--danger">Eliminar</button>
          </div>

          <div class="h2" style="margin-top:14px">Historial (solo pantalla)</div>
          <div id="pHistory" class="list list--compact"></div>

          <div class="hr"></div>
          <div class="h2">Precios externos</div>
          <div class="muted small">Link para otra persona: abrir <code>/prices.html</code>. También puedes exportar/importar patch.</div>
          <div class="inline">
            <button id="btnExportPricesPatch" class="btn btn--ghost">Exportar patch (JSON)</button>
            <button id="btnCopyPricesLink" class="btn btn--ghost">Copiar link patch</button>
            <input id="pricesLinkIn" class="input" placeholder="Pegar link patch aquí…" />
            <button id="btnImportPricesLink" class="btn btn--ghost">Importar</button>
          </div>
        </div>
      </div>
    </section>

    <!-- CONTABILIDAD -->
    <section id="tab-accounting" class="panel">
      <div class="row row--split">
        <div class="row__left">
          <div class="h1">Contabilidad</div>
          <div class="muted">Protegida con PIN. Filtros + KPIs.</div>
        </div>
      </div>

      <div class="card">
        <div class="inline">
          <input id="pinIn" class="input" placeholder="PIN" type="password" style="width:140px" />
          <button id="btnUnlock" class="btn">Desbloquear</button>
          <div id="pinState" class="badge">Bloqueada</div>
          <div class="spacer"></div>
          <button id="btnLock" class="btn btn--ghost">Bloquear</button>
        </div>
      </div>

      <div class="card">
        <div class="grid4">
          <label class="field"><span>Desde</span><input id="accFrom" class="input" type="date" /></label>
          <label class="field"><span>Hasta</span><input id="accTo" class="input" type="date" /></label>
          <label class="field"><span>Cliente</span><select id="accClient" class="input"></select></label>
          <label class="field"><span>Tag</span><input id="accTag" class="input" placeholder="opcional" /></label>
        </div>

        <div class="kpis">
          <div class="kpi"><div class="muted">Ventas</div><div id="kSales" class="kpi__v">0,00</div></div>
          <div class="kpi"><div class="muted">IVA (solo desglosado)</div><div id="kVat" class="kpi__v">0,00</div></div>
          <div class="kpi"><div class="muted">Nº facturas</div><div id="kCount" class="kpi__v">0</div></div>
          <div class="kpi"><div class="muted">Margen estimado</div><div id="kMargin" class="kpi__v">0,00</div></div>
        </div>

        <div id="accTable" class="list"></div>
      </div>
    </section>

    <!-- AJUSTES -->
    <section id="tab-settings" class="panel">
      <div class="row">
        <div class="h1">Ajustes</div>
        <div class="muted">Proveedor, IVA, transporte, QR, nube, backups.</div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="h2">Sistema</div>
          <div class="grid2">
            <label class="field"><span>IVA %</span><input id="setVatRate" class="input" type="number" step="0.01" /></label>
            <label class="field"><span>Modo IVA por defecto</span>
              <select id="setVatMode" class="input">
                <option value="breakdown">Desglosado</option>
                <option value="included">IVA incluido (sin desglose)</option>
              </select>
            </label>

            <label class="field"><span>Transporte %</span><input id="setTransportPct" class="input" type="number" step="0.01" /></label>
            <label class="field"><span>PIN contabilidad</span><input id="setPin" class="input" type="password" /></label>

            <label class="field col2"><span>Plantilla QR</span>
              <input id="setQrTpl" class="input" />
            </label>

            <label class="field col2"><span>Sync automático</span>
              <label class="chip"><input id="setAutoSync" type="checkbox" /> Guardar local + nube al cambiar (si hay login)</label>
            </label>
          </div>

          <div class="hr"></div>
          <div class="h2">Backup local</div>
          <div class="inline">
            <button id="btnExportJson" class="btn btn--ghost">Export JSON</button>
            <input id="importJsonFile" class="input" type="file" accept="application/json" />
            <button id="btnImportJson" class="btn btn--ghost">Import JSON</button>
          </div>

          <div class="hr"></div>
          <div class="h2">Reset</div>
          <div class="muted small">No borra “por accidente”. Requiere confirmación.</div>
          <div class="inline">
            <input id="resetCheck" class="input" placeholder='Escribe: BORRAR TODO' />
            <button id="btnReset" class="btn btn--danger">Borrar datos</button>
          </div>
        </div>

        <div class="card">
          <div class="h2">Nube (Firebase opcional)</div>
          <div class="muted small">Si falla Auth/DB (PERMISSION_DENIED, etc.), sigue en modo local.</div>

          <div class="grid2">
            <label class="field col2"><span>apiKey</span><input id="fbApiKey" class="input" /></label>
            <label class="field col2"><span>authDomain</span><input id="fbAuthDomain" class="input" /></label>
            <label class="field col2"><span>databaseURL</span><input id="fbDbUrl" class="input" /></label>
            <label class="field col2"><span>projectId</span><input id="fbProjectId" class="input" /></label>
            <label class="field col2"><span>storageBucket</span><input id="fbStorageBucket" class="input" /></label>
            <label class="field col2"><span>appId</span><input id="fbAppId" class="input" /></label>
          </div>

          <div class="inline">
            <button id="btnSaveFb" class="btn">Guardar config</button>
            <button id="btnTestFb" class="btn btn--ghost">Test</button>
          </div>

          <div class="hr"></div>
          <div class="h2">Login</div>
          <div class="grid2">
            <label class="field col2"><span>Email</span><input id="authEmail" class="input" /></label>
            <label class="field col2"><span>Password</span><input id="authPass" class="input" type="password" /></label>
          </div>
          <div class="inline">
            <button id="btnSignup" class="btn btn--ghost">Signup</button>
            <button id="btnSignin" class="btn">Signin</button>
            <button id="btnSignout" class="btn btn--ghost">Logout</button>
          </div>

          <div class="hr"></div>
          <div class="h2">Estado</div>
          <pre id="cloudLog" class="pre"></pre>
        </div>
      </div>
    </section>
  </main>

  <div id="toast" class="toast hidden"></div>

  <script type="module" src="./app.js"></script>
</body>
</html>
