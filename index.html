<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>ARSLAN • FACTURAS PRO — KIWI (BW)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
</head>

<body>
  <div class="app-shell" id="app">
    <div class="topbar">
      <div class="brand">
        <div class="kiwi-dot" aria-hidden="true"></div>
        <div>
          <div class="brand-title">ARSLAN • FACTURAS PRO</div>
          <div class="brand-sub" id="brandSub">KIWI Edition — Blanco/Negro</div>
        </div>
      </div>

      <div class="top-actions">
        <span class="user-pill" id="netPill">Modo local</span>
        <button class="btn" id="btnLogin">Entrar nube</button>
        <button class="btn" id="btnLogout" style="display:none;">Salir</button>
      </div>
    </div>

    <div class="main">
      <div class="nav" id="nav">
        <button class="nav-btn active" data-view="facturas">Facturas</button>
        <button class="nav-btn" data-view="productos">Productos</button>
        <button class="nav-btn" data-view="clientes">Clientes</button>
        <button class="nav-btn" data-view="reportes">Reportes</button>
        <button class="nav-btn" data-view="ajustes">Ajustes</button>
      </div>

      <div class="content">
        <!-- FACTURAS -->
        <section class="panel" id="view-facturas">
          <div class="panel-header sticky">
            <div class="header-left">
              <div class="title-big">Facturas</div>
              <div class="muted" id="facturasHint">Editor limpio — sin scroll horizontal</div>
            </div>
            <div class="header-actions">
              <button class="btn" id="btnNewInvoice">Nueva</button>
              <button class="btn" id="btnDupInvoice">Duplicar</button>
              <button class="btn danger" id="btnDelInvoice">Eliminar</button>
              <button class="btn primary" id="btnSaveInvoice">Guardar</button>
            </div>
          </div>

          <div class="two-cols">
            <!-- LISTA -->
            <div class="col list card pad">
              <div class="row gap wrap">
                <div class="field grow">
                  <label>Buscar</label>
                  <input id="invSearch" placeholder="Número, cliente, tag..." />
                </div>
                <div class="field" style="min-width:160px;">
                  <label>Filtro</label>
                  <select id="invFilter">
                    <option value="all">Todas</option>
                    <option value="withpdf">Con PDF</option>
                    <option value="nopdf">Sin PDF</option>
                  </select>
                </div>
              </div>

              <div class="mt10 listbox" id="invList"></div>
            </div>

            <!-- EDITOR -->
            <div class="col editor card pad">
              <div class="row gap wrap">
                <div class="field" style="min-width:160px;">
                  <label>Fecha</label>
                  <input id="invDate" type="date" />
                </div>
                <div class="field" style="min-width:220px;">
                  <label>Nº factura</label>
                  <input id="invNumber" placeholder="FA-..." />
                </div>
                <div class="field grow">
                  <label>Cliente</label>
                  <select id="invClient"></select>
                </div>
                <div class="field" style="min-width:200px;">
                  <label>Tag</label>
                  <input id="invTag" placeholder="Centro / Severo / ..." />
                </div>
              </div>

              <div class="mt10 row gap wrap">
                <button class="btn" id="btnAddLine">+ Línea</button>
                <button class="btn" id="btnFillLastPrices">Autollenar precios (últimos)</button>
                <button class="btn" id="btnPdfLocal">PDF</button>
                <button class="btn" id="btnPdfCloud">Guardar PDF nube</button>
                <button class="btn" id="btnOpenPdf" style="display:none;">Ver PDF nube</button>
                <button class="btn" id="btnWhats">WhatsApp</button>
              </div>

              <hr class="sep" />

              <div class="field">
                <label>Notas</label>
                <input id="invNotes" placeholder="Observaciones..." />
              </div>

              <div class="mt10">
                <div class="muted">Líneas (sin scroll horizontal)</div>
                <div class="lines" id="linesWrap"></div>
              </div>

              <hr class="sep" />

              <div class="totals">
                <div class="tot-line"><span>Subtotal</span><strong id="tSub">0,00 €</strong></div>
                <div class="tot-line" id="vatRow"><span>IVA (4%)</span><strong id="tVat">0,00 €</strong></div>
                <div class="tot-line big"><span>Total</span><strong id="tTotal">0,00 €</strong></div>
                <div class="hint" id="vatHint"></div>
              </div>

              <div class="mt10 muted" id="syncHint"></div>
            </div>
          </div>
        </section>

        <!-- PRODUCTOS -->
        <section class="panel" id="view-productos" style="display:none;">
          <div class="panel-header sticky">
            <div class="header-left">
              <div class="title-big">Productos</div>
              <div class="muted">Precios + kg/caja + historial (solo pantalla, NO se imprime)</div>
            </div>
            <div class="header-actions">
              <button class="btn" id="btnAddProd">Añadir</button>
              <button class="btn" id="btnSeedVocab">Cargar vocabulario</button>
              <button class="btn" id="btnExportData">Export JSON</button>
              <button class="btn file">Import JSON<input type="file" id="fileImport" accept="application/json"></button>
              <button class="btn danger" id="btnResetLocal">Reset local</button>
            </div>
          </div>

          <div class="pad">
            <div class="row gap wrap">
              <div class="field grow">
                <label>Buscar producto</label>
                <input id="prodSearch" placeholder="Ej: TOMATE RAMA" />
              </div>
              <div class="field" style="min-width:180px;">
                <label>Modo default</label>
                <select id="prodModeFilter">
                  <option value="all">Todos</option>
                  <option value="kg">kg</option>
                  <option value="unidad">ud</option>
                  <option value="caja">caja</option>
                </select>
              </div>
            </div>

            <div class="mt10 cat-head">
              <div>Producto</div>
              <div>Modo</div>
              <div>kg/caja</div>
              <div>Precio</div>
              <div>Moneda</div>
              <div>Últimos 5</div>
              <div>Notas</div>
              <div></div>
            </div>
            <div class="cat-list" id="prodList"></div>
          </div>
        </section>

        <!-- CLIENTES -->
        <section class="panel" id="view-clientes" style="display:none;">
          <div class="panel-header sticky">
            <div class="header-left">
              <div class="title-big">Clientes</div>
              <div class="muted">Tus clientes precargados + tags + modo IVA</div>
            </div>
            <div class="header-actions">
              <button class="btn" id="btnAddClient">Añadir</button>
            </div>
          </div>

          <div class="pad">
            <div class="row gap wrap">
              <div class="field grow">
                <label>Buscar cliente</label>
                <input id="cliSearch" placeholder="Nombre / NIF / Tag..." />
              </div>
            </div>

            <div class="mt10 acc-table">
              <table class="table">
                <thead>
                  <tr>
                    <th>Nombre</th>
                    <th>NIF</th>
                    <th>Dirección</th>
                    <th>Tags</th>
                    <th>IVA</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="cliTbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- REPORTES (PIN) -->
        <section class="panel" id="view-reportes" style="display:none;">
          <div class="panel-header sticky">
            <div class="header-left">
              <div class="title-big">Reportes & Contabilidad</div>
              <div class="muted">Protegido por PIN</div>
            </div>
            <div class="header-actions">
              <button class="btn" id="btnRefreshReports">Actualizar</button>
              <button class="btn" id="btnExportCSV">Export CSV</button>
            </div>
          </div>

          <div class="pad">
            <div class="card pad">
              <div class="muted">Resumen</div>
              <div class="kpi" id="kpiTotal">0,00 €</div>
              <div class="row gap wrap mt8">
                <span class="badge" id="kpiCount">0 facturas</span>
                <span class="badge" id="kpiWithPdf">0 con PDF</span>
                <span class="badge" id="kpiNoPdf">0 sin PDF</span>
              </div>
            </div>

            <div class="mt10 card pad">
              <div class="muted">Top clientes</div>
              <div class="mt8" id="topClients"></div>
            </div>

            <div class="mt10 card pad">
              <div class="muted">Por mes</div>
              <div class="mt8" id="byMonth"></div>
            </div>
          </div>
        </section>

        <!-- AJUSTES -->
        <section class="panel" id="view-ajustes" style="display:none;">
          <div class="panel-header sticky">
            <div class="header-left">
              <div class="title-big">Ajustes</div>
              <div class="muted">PIN reportes + Firebase (opcional)</div>
            </div>
            <div class="header-actions">
              <button class="btn primary" id="btnSaveSettings">Guardar ajustes</button>
            </div>
          </div>

          <div class="pad">
            <div class="grid-2">
              <div class="card pad">
                <div class="muted">PIN Reportes</div>
                <div class="mt8 field">
                  <label>Nuevo PIN</label>
                  <input id="pinSet" inputmode="numeric" placeholder="Ej: 7392" />
                </div>
                <div class="hint">Facturas siempre libres. Reportes pide PIN.</div>
              </div>

              <div class="card pad">
                <div class="muted">Datos del proveedor (emisor)</div>
                <div class="mt8 grid-2">
                  <div class="field"><label>Nombre</label><input id="issName"></div>
                  <div class="field"><label>NIF</label><input id="issNif"></div>
                  <div class="field"><label>Dirección</label><input id="issAddr"></div>
                  <div class="field"><label>Tel</label><input id="issTel"></div>
                  <div class="field" style="grid-column:1/-1;"><label>Email</label><input id="issEmail"></div>
                </div>
              </div>
            </div>

            <div class="mt10 card pad">
              <div class="muted">Firebase (opcional — si está vacío, funciona offline)</div>
              <div class="hint">Pega aquí tu config de Firebase (JSON). Si no pones nada, no hay nube.</div>
              <div class="mt8 field">
                <label>firebaseConfig JSON</label>
                <input id="fbConfig" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"..."}' />
              </div>
              <div class="hint">Luego usa “Entrar nube” arriba.</div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <!-- MODAL GENERICO -->
    <div id="modal" class="modal" style="display:none;">
      <div class="modal-card">
        <div class="modal-title" id="modalTitle">Título</div>
        <div class="mt8" id="modalBody"></div>
        <div class="mt10 row gap" style="justify-content:flex-end;">
          <button class="btn" id="modalCancel">Cancelar</button>
          <button class="btn primary" id="modalOk">OK</button>
        </div>
      </div>
    </div>

    <!-- CANVAS QR helper (oculto) -->
    <canvas id="qrCanvas" width="180" height="180" style="display:none;"></canvas>
  </div>

  <script type="module" src="./app.js"></script>
</body>
</html>
