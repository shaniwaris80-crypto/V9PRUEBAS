<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN ‚Ä¢ FACTURAS ‚Äî KIWI Edition</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="bw-pro">
  <div class="app">

    <header class="topbar">
      <div class="brand">
        <span class="dot"></span>
        <div class="brand-text">
          <div class="title">ARSLAN ‚Ä¢ FACTURAS</div>
          <div class="subtitle">KIWI Edition ¬∑ B/W ¬∑ Offline + Cloud (opcional)</div>
        </div>
      </div>

      <div class="top-actions">
        <div class="pill" id="cloudPill">Modo local</div>
        <button class="btn" id="btnLogin">Cloud</button>
        <button class="btn" id="btnSync" title="Sincronizar (si Cloud est√° configurado)">Sync</button>
        <button class="btn" id="btnExport">Export</button>
        <button class="btn" id="btnImport">Import</button>
        <input type="file" id="fileImport" accept="application/json" hidden />
      </div>
    </header>

    <nav class="tabs" role="tablist">
      <button class="tab active" data-view="viewFactura">Factura</button>
      <button class="tab" data-view="viewFacturas">Facturas</button>
      <button class="tab" data-view="viewClientes">Clientes</button>
      <button class="tab" data-view="viewProductos">Productos</button>
      <button class="tab" data-view="viewContabilidad">Contabilidad üîí</button>
      <button class="tab" data-view="viewAjustes">Ajustes</button>
    </nav>

    <main class="main">

      <!-- =========================
           FACTURA (PRO)
      ========================== -->
      <section id="viewFactura" class="view active">
        <div class="view-head">
          <h2>Factura</h2>
          <div class="head-actions">
            <button class="btn" id="btnNewInvoice">+ Nueva</button>
            <button class="btn" id="btnDuplicateInvoice">Duplicar</button>
            <button class="btn danger" id="btnDeleteInvoice">Eliminar</button>
          </div>
        </div>

        <!-- 3 bloques: Proveedor / QR / Cliente -->
        <div class="grid3 top-cards">
          <div class="card">
            <div class="card-title">Proveedor</div>
            <div class="form-col">
              <input id="provName" placeholder="Nombre" />
              <input id="provNif" placeholder="NIF" />
              <input id="provAddr" placeholder="Direcci√≥n" />
              <input id="provPhone" placeholder="Tel√©fono" />
              <input id="provEmail" placeholder="Email" />
            </div>
          </div>

          <div class="card center-card">
            <div class="card-title">QR AEAT</div>
            <div class="qrWrap">
              <div class="qrBox" id="qrBox"></div>
            </div>
            <div class="mini muted" id="qrMiniText">‚Äî</div>
          </div>

          <div class="card">
            <div class="card-title">Cliente</div>
            <div class="form-col">
              <select id="invClient"></select>
              <input id="cliName" placeholder="Nombre fiscal / cliente" />
              <input id="cliNif" placeholder="NIF/CIF" />
              <input id="cliAddr" placeholder="Direcci√≥n" />
              <input id="cliPhone" placeholder="Tel√©fono" />
              <input id="cliEmail" placeholder="Email" />
            </div>
          </div>
        </div>

        <!-- Datos factura -->
        <div class="card">
          <div class="row2">
            <div>
              <label class="lbl">N¬∫ factura</label>
              <input id="invNumber" />
            </div>
            <div>
              <label class="lbl">Fecha</label>
              <input id="invDate" type="date" />
            </div>
          </div>

          <div class="row2">
            <div>
              <label class="lbl">Tags (opcional)</label>
              <input id="invTags" placeholder="Ej: Braseros Centro, Riviera, ..." />
              <div class="mini muted">Se guardan para reportes y b√∫squeda.</div>
            </div>
            <div>
              <label class="lbl">Notas</label>
              <input id="invNotes" placeholder="Observaciones internas / pago / etc." />
              <div class="mini muted">Solo interno (y opcional en PDF).</div>
            </div>
          </div>
        </div>

        <!-- Cuadro de c√°lculo -->
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Cuadro de c√°lculo</div>
              <div class="mini muted">Autocomplete sin sustituir. Enter ‚Üí siguiente. Flechas ‚Üë‚Üì en sugerencias.</div>
            </div>
            <div class="card-actions">
              <button class="btn" id="btnAddLine">+ A√±adir l√≠nea</button>
              <button class="btn" id="btnClearLines">Vaciar</button>
            </div>
          </div>

          <div class="calc-head">
            <div>Producto</div>
            <div>Modo</div>
            <div>Cant.</div>
            <div>Bruto (kg)</div>
            <div>Tara (kg)</div>
            <div>Neto (kg)</div>
            <div>Precio</div>
            <div>Origen</div>
            <div>Importe</div>
            <div></div>
          </div>

          <div id="linesWrap" class="calc-body"></div>

          <datalist id="dlProducts"></datalist>

          <div class="divider"></div>

          <div class="grid3 bottom-cards">
            <!-- Totales -->
            <div class="card soft">
              <div class="card-title">Totales factura</div>

              <div class="check-row">
                <label class="chk">
                  <input type="checkbox" id="invTransportOn" />
                  <span>A√±adir transporte <span class="muted" id="transportRateLabel">10%</span></span>
                </label>

                <label class="chk">
                  <input type="checkbox" id="invTaxIncluded" />
                  <span>IVA 4% incluido (sin desglose)</span>
                </label>
              </div>

              <div class="totals">
                <div class="trow"><span>Subtotal</span><strong id="tSubtotal">0,00 ‚Ç¨</strong></div>
                <div class="trow"><span>Transporte</span><strong id="tTransport">0,00 ‚Ç¨</strong></div>
                <div class="trow"><span>IVA (4%)</span><strong id="tIva">0,00 ‚Ç¨</strong></div>
                <div class="trow big"><span>TOTAL</span><strong id="tTotal">0,00 ‚Ç¨</strong></div>
              </div>

              <div class="mini muted" id="taxNote">‚Äî</div>
            </div>

            <!-- Pagos -->
            <div class="card soft">
              <div class="card-title">Pagos</div>

              <div class="form-col">
                <div class="row2">
                  <input id="payAmount" type="number" inputmode="decimal" placeholder="Importe parcial" />
                  <button class="btn" id="btnAddPay">+ A√±adir pago</button>
                </div>

                <div class="mini muted">Pagos parciales:</div>
                <div id="payList" class="payList"></div>

                <label class="lbl">Pagado manual</label>
                <input id="payManual" type="number" inputmode="decimal" placeholder="0" />

                <div class="row2">
                  <div>
                    <label class="lbl">Estado</label>
                    <select id="invStatus">
                      <option value="impagada">Impagada</option>
                      <option value="parcial">Parcial</option>
                      <option value="pagada">Pagada</option>
                    </select>
                  </div>
                  <div>
                    <label class="lbl">M√©todo</label>
                    <select id="invMethod">
                      <option value="efectivo">Efectivo</option>
                      <option value="transferencia">Transferencia</option>
                      <option value="tarjeta">Tarjeta</option>
                      <option value="otros">Otros</option>
                    </select>
                  </div>
                </div>

                <div class="trow big">
                  <span>Pendiente</span>
                  <strong id="tPending">0,00 ‚Ç¨</strong>
                </div>
              </div>
            </div>

            <!-- Observaciones -->
            <div class="card soft">
              <div class="card-title">Observaciones</div>
              <textarea id="invObs" rows="9" placeholder="Notas / condiciones / etc."></textarea>
            </div>
          </div>

          <div class="footer-actions">
            <button class="btn primary" id="btnSaveInvoice">üíæ Guardar</button>
            <button class="btn primary" id="btnPDF">üßæ Generar PDF</button>
            <button class="btn" id="btnPDFCloud" title="Si Cloud est√° activo, sube el PDF y guarda el link">PDF + Cloud</button>
            <button class="btn" id="btnWhats">WhatsApp</button>

            <div class="right-mini">
              <div class="mini muted" id="pdfState">‚Äî</div>
              <button class="btn" id="btnOpenPdf" disabled>Abrir PDF</button>
              <button class="btn" id="btnCopyPdf" disabled>Copiar link</button>
            </div>
          </div>
        </div>
      </section>

      <!-- =========================
           FACTURAS (LISTADO)
      ========================== -->
      <section id="viewFacturas" class="view">
        <div class="view-head">
          <h2>Facturas</h2>
          <div class="head-actions">
            <input id="invSearch" class="search" placeholder="Buscar por n¬∫ / cliente / tag..." />
            <button class="btn" id="btnInvClearSearch">Limpiar</button>
          </div>
        </div>

        <div class="card">
          <div id="invList" class="list"></div>
        </div>
      </section>

      <!-- =========================
           CLIENTES
      ========================== -->
      <section id="viewClientes" class="view">
        <div class="view-head">
          <h2>Clientes</h2>
          <div class="head-actions">
            <input id="cliSearch" class="search" placeholder="Buscar cliente..." />
            <button class="btn" id="btnAddClient">+ A√±adir</button>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="card-title">Listado</div>
            <div id="cliList" class="list"></div>
          </div>

          <div class="card">
            <div class="card-title">Editar cliente</div>
            <div class="form-col">
              <input id="editCliName" placeholder="Nombre fiscal / cliente" />
              <input id="editCliNif" placeholder="NIF/CIF" />
              <input id="editCliAddr" placeholder="Direcci√≥n" />
              <input id="editCliPhone" placeholder="Tel√©fono" />
              <input id="editCliEmail" placeholder="Email" />
              <input id="editCliTags" placeholder="Tags (opcional)" />
              <div class="row2">
                <button class="btn primary" id="btnSaveClient">Guardar</button>
                <button class="btn danger" id="btnDeleteClient">Eliminar</button>
              </div>
              <div class="mini muted" id="cliEditMsg">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <!-- =========================
           PRODUCTOS
      ========================== -->
      <section id="viewProductos" class="view">
        <div class="view-head">
          <h2>Productos</h2>
          <div class="head-actions">
            <input id="prdSearch" class="search" placeholder="Buscar producto..." />
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="card-title">Listado (vocabulario)</div>
            <div id="prdList" class="list"></div>
          </div>

          <div class="card">
            <div class="card-title">Editar producto</div>
            <div class="form-col">
              <input id="editPrdName" placeholder="Producto" disabled />
              <div class="row2">
                <div>
                  <label class="lbl">Unidad por defecto</label>
                  <select id="editPrdUnit">
                    <option value="kg">kg</option>
                    <option value="caja">caja</option>
                    <option value="ud">ud</option>
                  </select>
                </div>
                <div>
                  <label class="lbl">Kg por caja (si aplica)</label>
                  <input id="editPrdKgBox" type="number" inputmode="decimal" placeholder="0" />
                </div>
              </div>

              <div class="row2">
                <div>
                  <label class="lbl">Precio actual</label>
                  <input id="editPrdPrice" type="number" inputmode="decimal" placeholder="0" />
                </div>
                <div>
                  <label class="lbl">Coste (margen)</label>
                  <input id="editPrdCost" type="number" inputmode="decimal" placeholder="0" />
                </div>
              </div>

              <label class="lbl">Origen por defecto (opcional)</label>
              <input id="editPrdOrigin" placeholder="Origen" />

              <div class="row2">
                <button class="btn primary" id="btnSaveProduct">Guardar</button>
                <button class="btn" id="btnResetProduct">Reset</button>
              </div>

              <div class="mini muted">Historial (√∫ltimas 5):</div>
              <div id="prdHistory" class="history"></div>

              <div class="mini muted" id="prdEditMsg">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

      <!-- =========================
           CONTABILIDAD (PIN)
      ========================== -->
      <section id="viewContabilidad" class="view">
        <div class="view-head">
          <h2>Contabilidad</h2>
          <div class="head-actions">
            <button class="btn" id="btnUnlockAcc">Desbloquear</button>
            <button class="btn" id="btnLockAcc">Bloquear</button>
            <div class="pill" id="accStatus">Bloqueado</div>
          </div>
        </div>

        <div class="card">
          <div class="grid3">
            <div>
              <label class="lbl">Desde</label>
              <input id="accFrom" type="date" />
            </div>
            <div>
              <label class="lbl">Hasta</label>
              <input id="accTo" type="date" />
            </div>
            <div>
              <label class="lbl">Cliente</label>
              <select id="accClient"></select>
            </div>
          </div>

          <div class="row2">
            <div>
              <label class="lbl">Tag (opcional)</label>
              <input id="accTag" placeholder="Filtrar por tag..." />
            </div>
            <div class="right">
              <button class="btn primary" id="btnRunAcc">Calcular</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="grid4 kpis">
            <div class="kpi"><div class="mini muted">Ventas</div><div class="kpiVal" id="kSales">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="mini muted">IVA</div><div class="kpiVal" id="kIva">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="mini muted">Facturas</div><div class="kpiVal" id="kCount">0</div></div>
            <div class="kpi"><div class="mini muted">Margen est.</div><div class="kpiVal" id="kMargin">0,00 ‚Ç¨</div></div>
          </div>

          <div class="divider"></div>

          <div class="tableWrap">
            <table class="table" id="accTable">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>N¬∫</th>
                  <th>Cliente</th>
                  <th>Total</th>
                  <th>Tags</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="5" class="muted">Contabilidad bloqueada. Pulsa ‚ÄúDesbloquear‚Äù.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- =========================
           AJUSTES
      ========================== -->
      <section id="viewAjustes" class="view">
        <div class="view-head">
          <h2>Ajustes</h2>
        </div>

        <div class="grid2">
          <div class="card">
            <div class="card-title">Impuestos y transporte</div>
            <div class="form-col">
              <div class="row2">
                <div>
                  <label class="lbl">IVA (por defecto)</label>
                  <input id="setTaxRate" type="number" inputmode="decimal" placeholder="0.04" />
                </div>
                <div>
                  <label class="lbl">Transporte %</label>
                  <input id="setTransportRate" type="number" inputmode="decimal" placeholder="0.10" />
                </div>
              </div>

              <label class="lbl">QR AEAT (plantilla)</label>
              <input id="setQrTemplate" placeholder="AEAT|NIF={NIF}|NUM={NUM}|FECHA={FECHA}|TOTAL={TOTAL}" />

              <label class="lbl">PIN (Contabilidad)</label>
              <input id="setPin" placeholder="7392" />

              <div class="row2">
                <button class="btn primary" id="btnSaveSettings">Guardar ajustes</button>
                <button class="btn" id="btnResetSettings">Reset</button>
              </div>

              <div class="mini muted" id="setMsg">‚Äî</div>
            </div>
          </div>

          <div class="card">
            <div class="card-title">Cloud (Firebase) ‚Äî opcional</div>
            <div class="mini muted">
              Si NO lo configuras, todo sigue en modo local sin errores.
            </div>

            <div class="form-col">
              <input id="fbApiKey" placeholder="apiKey" />
              <input id="fbAuthDomain" placeholder="authDomain" />
              <input id="fbDbUrl" placeholder="databaseURL" />
              <input id="fbProjectId" placeholder="projectId" />
              <input id="fbAppId" placeholder="appId" />
              <input id="fbStorageBucket" placeholder="storageBucket" />

              <div class="row2">
                <button class="btn primary" id="btnSaveFirebase">Guardar Firebase</button>
                <button class="btn" id="btnDisableFirebase">Desactivar Cloud</button>
              </div>

              <div class="mini muted" id="fbMsg">‚Äî</div>
            </div>
          </div>
        </div>
      </section>

    </main>

    <!-- =========================
         MODAL CLOUD LOGIN
    ========================== -->
    <div class="modal" id="loginModal" style="display:none;">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">Cloud</div>
          <button class="btn" id="btnLoginClose">Cerrar</button>
        </div>

        <div class="form-col">
          <input id="loginEmail" placeholder="Email" />
          <input id="loginPass" type="password" placeholder="Password" />
          <div class="row2">
            <button class="btn primary" id="btnDoLogin">Entrar</button>
            <button class="btn" id="btnDoSignup">Crear cuenta</button>
          </div>
          <button class="btn" id="btnLogout" style="display:none;">Cerrar sesi√≥n</button>
          <div class="mini muted" id="loginMsg">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- =========================
         MODAL PIN
    ========================== -->
    <div class="modal" id="pinModal" style="display:none;">
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title">PIN Contabilidad</div>
          <button class="btn" id="btnPinClose">Cerrar</button>
        </div>

        <div class="form-col">
          <input id="pinInput" type="password" placeholder="PIN" />
          <div class="row2">
            <button class="btn primary" id="btnPinOk">OK</button>
            <button class="btn" id="btnPinCancel">Cancelar</button>
          </div>
          <div class="mini muted" id="pinMsg">‚Äî</div>
        </div>
      </div>
    </div>

  </div>

  <script type="module" src="./app.js"></script>
</body>
</html>
