<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN ‚Ä¢ FACTURAS ‚Äî KIWI EDITION (B/W)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div>
        <div class="brandTitle">ARSLAN ‚Ä¢ FACTURAS</div>
        <div class="brandSub">KIWI Edition ¬∑ B/W ¬∑ Offline + Cloud</div>
      </div>
    </div>

    <div class="topActions">
      <div id="cloudInfo" class="pill">Cloud: OFF (local)</div>
      <button id="btnLocal" class="btn ghost">Modo local</button>
      <button id="btnExport" class="btn">Export</button>
      <button id="btnImport" class="btn">Import</button>
      <input id="fileImport" type="file" accept="application/json" hidden />
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="tabFacturas">Facturas</button>
    <button class="tab" data-tab="tabClientes">Clientes</button>
    <button class="tab" data-tab="tabProductos">Productos</button>
    <button class="tab" data-tab="tabContabilidad">Contabilidad üîí</button>
    <button class="tab" data-tab="tabAjustes">Ajustes</button>
  </nav>

  <main class="wrap">

    <!-- ======================
         TAB FACTURAS
    ======================= -->
    <section id="tabFacturas" class="panel show">

      <div class="factLayout">

        <!-- LEFT: listado -->
        <aside class="listPanel">
          <div class="listHeader">
            <input id="invSearch" class="input" placeholder="Buscar factura (n¬∫ / cliente / tag)" />
            <div class="listMini">
              <button id="btnNewInvoice" class="btn">+ Nueva</button>
              <button id="btnDupInvoice" class="btn ghost">Duplicar</button>
              <button id="btnDelInvoice" class="btn danger">Eliminar</button>
            </div>
          </div>

          <div class="listBox">
            <div class="listTitle">Facturas</div>
            <div id="invoiceList" class="invoiceList"></div>
          </div>
        </aside>

        <!-- RIGHT: editor -->
        <section class="editorPanel">

          <!-- Top actions -->
          <div class="editorTop">
            <div class="editorTitle">
              <div class="h1">Factura</div>
              <div class="muted">GRID PRO (sin scroll horizontal) ¬∑ PDF PRO ¬∑ QR AEAT</div>
            </div>

            <div class="editorBtns">
              <button id="btnSaveInvoice" class="btn">Guardar</button>
              <button id="btnPDF" class="btn ghost">PDF</button>
              <button id="btnPDFCloud" class="btn ghost">PDF + Nube</button>
              <button id="btnWhats" class="btn">WhatsApp</button>
              <button id="btnSync" class="btn ghost">Sync</button>
              <button id="btnCloudLogin" class="btn ghost">Login</button>
            </div>
          </div>

          <!-- Provider + QR + Client (3 columnas) -->
          <div class="triple">
            <div class="card">
              <div class="cardTitle">Proveedor</div>
              <input id="provName" class="input" placeholder="Nombre" />
              <input id="provNif" class="input" placeholder="NIF" />
              <input id="provAddr" class="input" placeholder="Direcci√≥n" />
              <div class="grid2">
                <input id="provPhone" class="input" placeholder="Tel√©fono" />
                <input id="provEmail" class="input" placeholder="Email" />
              </div>
              <button id="btnSaveProvider" class="btn ghost w100">Guardar proveedor</button>
            </div>

            <div class="card centerCard">
              <div class="cardTitle">QR (AEAT)</div>
              <div id="qrBox" class="qrBox"></div>
              <div class="muted tiny" id="qrHint">Se genera autom√°ticamente al guardar.</div>
              <div class="grid2">
                <button id="btnRegenQR" class="btn ghost">Regenerar</button>
                <button id="btnCopyQR" class="btn ghost">Copiar texto</button>
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">Cliente</div>
              <select id="invClient" class="input"></select>
              <div class="grid2">
                <input id="cliName" class="input" placeholder="Nombre cliente" />
                <input id="cliNif" class="input" placeholder="NIF/CIF" />
              </div>
              <input id="cliAddr" class="input" placeholder="Direcci√≥n" />
              <div class="grid2">
                <input id="cliPhone" class="input" placeholder="Tel√©fono" />
                <input id="cliEmail" class="input" placeholder="Email" />
              </div>
              <div class="grid2">
                <button id="btnNewClientInline" class="btn ghost">Nuevo</button>
                <button id="btnSaveClientInline" class="btn">Guardar</button>
              </div>
            </div>
          </div>

          <!-- Meta factura -->
          <div class="metaRow">
            <div class="metaCol">
              <label class="lbl">Fecha</label>
              <input id="invDate" type="date" class="input" />
            </div>
            <div class="metaCol">
              <label class="lbl">N¬∫ factura</label>
              <input id="invNumber" class="input" placeholder="FA-YYYYMMDDHHMM" />
            </div>
            <div class="metaCol wide">
              <label class="lbl">Tags (opcional)</label>
              <input id="invTags" class="input" placeholder="Ej: Braseros Centro, Riviera..." />
            </div>
          </div>

          <div class="metaRow">
            <div class="metaCol wide">
              <label class="lbl">Notas internas</label>
              <input id="invNotes" class="input" placeholder="Observaciones internas / pago / etc." />
            </div>
            <div class="metaCol wide">
              <label class="lbl">Observaciones (PDF)</label>
              <input id="invObs" class="input" placeholder="Se imprimen en PDF (si quieres)" />
            </div>
          </div>

          <!-- GRID PRO l√≠neas -->
          <div class="linesCard">
            <div class="linesHead">
              <div>
                <div class="cardTitle">L√≠neas de producto (GRID PRO)</div>
                <div class="muted tiny">Autocomplete por teclado: ‚Üë ‚Üì y Enter (NO sustituye autom√°tico).</div>
              </div>
              <div class="linesBtns">
                <button id="btnAddLine" class="btn">+ A√±adir l√≠nea</button>
                <button id="btnClearLines" class="btn ghost">Vaciar</button>
              </div>
            </div>

            <div class="gridHeader">
              <div>Producto</div>
              <div>Modo</div>
              <div>Cant.</div>
              <div>Bruto</div>
              <div>Tara</div>
              <div>Neto</div>
              <div>Precio</div>
              <div>Origen</div>
              <div>Importe</div>
              <div></div>
            </div>

            <div id="linesBody" class="linesBody"></div>
          </div>

          <!-- Totales + pagos + ajustes -->
          <div class="bottom3">
            <div class="card">
              <div class="cardTitle">Totales factura</div>
              <label class="check">
                <input id="chkTransport" type="checkbox" />
                <span>A√±adir transporte 10%</span>
              </label>
              <label class="check">
                <input id="chkIvaIncluido" type="checkbox" />
                <span>IVA incluido en precios (sin desglose)</span>
              </label>

              <div class="totRow"><span>Subtotal</span><b id="tSubtotal">0,00 ‚Ç¨</b></div>
              <div class="totRow"><span>Transporte</span><b id="tTransport">0,00 ‚Ç¨</b></div>
              <div class="totRow"><span>IVA (4%)</span><b id="tIva">0,00 ‚Ç¨</b></div>
              <div class="totRow big"><span>TOTAL</span><b id="tTotal">0,00 ‚Ç¨</b></div>
            </div>

            <div class="card">
              <div class="cardTitle">Pagos</div>
              <div class="muted tiny">Pagos parciales (opcional)</div>

              <div class="grid2">
                <input id="payAmount" class="input" placeholder="Importe parcial" inputmode="decimal" />
                <button id="btnAddPay" class="btn">+ A√±adir</button>
              </div>

              <div id="payList" class="payList"></div>

              <label class="lbl mt">Estado</label>
              <select id="payStatus" class="input">
                <option value="pendiente">Pendiente</option>
                <option value="pagada">Pagada</option>
              </select>

              <label class="lbl mt">M√©todo</label>
              <select id="payMethod" class="input">
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
                <option value="Bizum">Bizum</option>
                <option value="Otros">Otros</option>
              </select>

              <div class="totRow mt"><span>Pendiente</span><b id="tPending">0,00 ‚Ç¨</b></div>
            </div>

            <div class="card">
              <div class="cardTitle">Vista r√°pida (solo pantalla)</div>
              <div id="invoicePreview" class="preview"></div>
              <div class="muted tiny">‚ö†Ô∏è ‚Äú√öltimos precios‚Äù solo se muestran en pantalla. No se imprimen.</div>
            </div>
          </div>

        </section>
      </div>
    </section>

    <!-- ======================
         TAB CLIENTES
    ======================= -->
    <section id="tabClientes" class="panel">
      <div class="twoCols">

        <div class="card">
          <div class="cardTitle">Listado</div>
          <input id="cliSearch" class="input" placeholder="Buscar cliente..." />
          <div id="clientList" class="listSimple"></div>
          <div class="grid2 mt">
            <button id="btnNewClient" class="btn ghost">+ Nuevo</button>
            <button id="btnSaveClient" class="btn">Guardar</button>
          </div>
          <button id="btnDelClient" class="btn danger w100 mt">Eliminar cliente</button>
        </div>

        <div class="card">
          <div class="cardTitle">Editor</div>
          <input id="cliId" class="input" placeholder="ID (auto)" disabled />
          <label class="lbl">Nombre</label>
          <input id="cliEditName" class="input" placeholder="Nombre" />
          <label class="lbl">Alias / Comercial</label>
          <input id="cliEditAlias" class="input" placeholder="Alias" />
          <div class="grid2">
            <div>
              <label class="lbl">NIF/CIF</label>
              <input id="cliEditNif" class="input" placeholder="NIF/CIF" />
            </div>
            <div>
              <label class="lbl">Tel√©fono</label>
              <input id="cliEditPhone" class="input" placeholder="Tel√©fono" />
            </div>
          </div>
          <label class="lbl">Direcci√≥n</label>
          <input id="cliEditAddr" class="input" placeholder="Direcci√≥n" />
          <label class="lbl">Email</label>
          <input id="cliEditEmail" class="input" placeholder="Email" />
          <label class="lbl">Notas</label>
          <textarea id="cliEditNotes" class="input" rows="5" placeholder="Notas"></textarea>
        </div>

      </div>
    </section>

    <!-- ======================
         TAB PRODUCTOS
    ======================= -->
    <section id="tabProductos" class="panel">
      <div class="twoCols">

        <div class="card">
          <div class="cardTitle">Listado productos</div>
          <input id="prodSearch" class="input" placeholder="Buscar producto..." />
          <div id="productList" class="listSimple"></div>
          <div class="grid2 mt">
            <button id="btnNewProd" class="btn ghost">+ Nuevo</button>
            <button id="btnSaveProd" class="btn">Guardar</button>
          </div>
          <button id="btnDelProd" class="btn danger w100 mt">Eliminar producto</button>
        </div>

        <div class="card">
          <div class="cardTitle">Editor producto</div>
          <input id="prodKey" class="input" placeholder="Key (auto)" disabled />

          <label class="lbl">Nombre</label>
          <input id="prodName" class="input" placeholder="Nombre (estandar)" />

          <div class="grid2">
            <div>
              <label class="lbl">Modo por defecto</label>
              <select id="prodMode" class="input">
                <option value="kg">kg</option>
                <option value="caja">caja</option>
                <option value="ud">unidad</option>
              </select>
            </div>
            <div>
              <label class="lbl">Kg por caja (opcional)</label>
              <input id="prodKgBox" class="input" placeholder="Ej: 10" inputmode="decimal" />
            </div>
          </div>

          <div class="grid3">
            <div>
              <label class="lbl">Precio ‚Ç¨/kg</label>
              <input id="prodPriceKg" class="input" inputmode="decimal" placeholder="0.00" />
            </div>
            <div>
              <label class="lbl">Precio ‚Ç¨/caja</label>
              <input id="prodPriceBox" class="input" inputmode="decimal" placeholder="0.00" />
            </div>
            <div>
              <label class="lbl">Precio ‚Ç¨/ud</label>
              <input id="prodPriceUd" class="input" inputmode="decimal" placeholder="0.00" />
            </div>
          </div>

          <div class="grid2">
            <div>
              <label class="lbl">Coste ‚Ç¨/kg (margen)</label>
              <input id="prodCost" class="input" inputmode="decimal" placeholder="0.00" />
            </div>
            <div>
              <label class="lbl">Origen (default)</label>
              <input id="prodOrigin" class="input" placeholder="Origen" />
            </div>
          </div>

          <label class="lbl">Historial (√∫ltimas 5 veces)</label>
          <div id="prodHistory" class="historyBox muted tiny">‚Äî</div>
        </div>

      </div>
    </section>

    <!-- ======================
         TAB CONTABILIDAD (PIN)
    ======================= -->
    <section id="tabContabilidad" class="panel">
      <div class="card">
        <div class="cardTitle">Contabilidad avanzada (PIN)</div>
        <div id="accStatus" class="muted">Bloqueado üîí</div>

        <div class="grid2 mt">
          <input id="pinInput" class="input" placeholder="PIN" inputmode="numeric" />
          <div class="grid2">
            <button id="btnUnlock" class="btn">Desbloquear</button>
            <button id="btnLock" class="btn ghost">Bloquear</button>
          </div>
        </div>

        <hr class="hr"/>

        <div class="grid3">
          <div>
            <label class="lbl">Desde</label>
            <input id="accFrom" type="date" class="input" />
          </div>
          <div>
            <label class="lbl">Hasta</label>
            <input id="accTo" type="date" class="input" />
          </div>
          <div>
            <label class="lbl">Cliente</label>
            <select id="accClient" class="input"></select>
          </div>
        </div>

        <div class="grid2 mt">
          <button id="btnAccCalc" class="btn">Calcular</button>
          <div class="pill">Ventas: <b id="accSales">0,00 ‚Ç¨</b> ¬∑ IVA: <b id="accIva">0,00 ‚Ç¨</b> ¬∑ N¬∫: <b id="accN">0</b> ¬∑ Margen: <b id="accMargin">0,00 ‚Ç¨</b></div>
        </div>

        <div class="tableWrap mt">
          <table id="accTable" class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>N¬∫</th>
                <th>Cliente</th>
                <th style="text-align:right;">Total</th>
                <th style="text-align:right;">Coste</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

      </div>
    </section>

    <!-- ======================
         TAB AJUSTES
    ======================= -->
    <section id="tabAjustes" class="panel">
      <div class="twoCols">

        <div class="card">
          <div class="cardTitle">Sistema</div>
          <label class="lbl">PIN contabilidad</label>
          <input id="setPin" class="input" placeholder="Ej: 1234" inputmode="numeric" />
          <label class="lbl">IVA (%)</label>
          <input id="setIva" class="input" inputmode="decimal" placeholder="4" />
          <label class="lbl">Transporte (%)</label>
          <input id="setTransport" class="input" inputmode="decimal" placeholder="10" />
          <button id="btnSaveSettings" class="btn w100 mt">Guardar ajustes</button>
        </div>

        <div class="card">
          <div class="cardTitle">Cloud (Firebase opcional)</div>
          <div class="muted tiny">Si no configuras Firebase, funciona 100% offline (LocalStorage).</div>

          <label class="lbl">apiKey</label>
          <input id="fbApiKey" class="input" placeholder="..." />

          <label class="lbl">authDomain</label>
          <input id="fbAuthDomain" class="input" placeholder="..." />

          <label class="lbl">databaseURL</label>
          <input id="fbDatabaseURL" class="input" placeholder="..." />

          <label class="lbl">projectId</label>
          <input id="fbProjectId" class="input" placeholder="..." />

          <label class="lbl">appId</label>
          <input id="fbAppId" class="input" placeholder="..." />

          <label class="lbl">storageBucket (opcional)</label>
          <input id="fbStorageBucket" class="input" placeholder="..." />

          <div class="grid2 mt">
            <button id="btnSaveFirebase" class="btn">Guardar</button>
            <button id="btnTestFirebase" class="btn ghost">Test</button>
          </div>
        </div>

      </div>
    </section>

  </main>

  <!-- Modal Login -->
  <div id="loginModal" class="modal">
    <div class="modalCard">
      <div class="modalTitle">Login Cloud (Firebase)</div>
      <input id="loginEmail" class="input" placeholder="Email" />
      <input id="loginPass" class="input" placeholder="Contrase√±a" type="password" />
      <div class="grid2 mt">
        <button id="btnLoginDo" class="btn">Entrar</button>
        <button id="btnLogout" class="btn ghost">Salir</button>
      </div>
      <button id="btnCloseLogin" class="btn ghost w100 mt">Cerrar</button>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script src="./app.js"></script>
</body>
</html>
