<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ARSLAN ‚Ä¢ KIWI FACTURAS PRO</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700;800&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- ‚úÖ jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <!-- ‚úÖ QR -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>

  <meta name="theme-color" content="#16a34a" />
</head>

<body>
  <!-- TOPBAR -->
  <header class="topbar">
    <div class="brand">
      <div class="kiwi"></div>
      <div class="brandText">
        <div class="brandName">ARSLAN <span>KIWI</span></div>
        <div class="brandSub">Facturas & Contabilidad PRO</div>
      </div>
    </div>

    <div class="topbarRight">
      <button class="btn ghost" id="btnSync" title="Sincronizar nube">
        ‚òÅÔ∏è Sync
      </button>
      <button class="btn ghost" id="btnExportJson" title="Exportar JSON local">
        ‚¨áÔ∏è Export
      </button>
      <button class="btn ghost" id="btnImportJson" title="Importar JSON">
        ‚¨ÜÔ∏è Import
      </button>

      <div class="userChip" id="userChip" hidden>
        <div class="dot"></div>
        <div>
          <div class="uName" id="uEmail">‚Äî</div>
          <div class="uSmall" id="uUid">‚Äî</div>
        </div>
      </div>

      <button class="btn danger" id="btnLogout" hidden>Salir</button>
    </div>
  </header>

  <!-- LOGIN -->
  <section class="loginWrap" id="loginWrap">
    <div class="card loginCard">
      <h1>Iniciar sesi√≥n</h1>
      <p class="muted">Acceso nube real (Firebase). Las facturas se sincronizan en todos tus dispositivos.</p>

      <div class="formGrid">
        <label class="lbl">
          <span>Email</span>
          <input id="loginEmail" type="email" placeholder="tuemail@..." autocomplete="email" />
        </label>

        <label class="lbl">
          <span>Contrase√±a</span>
          <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
        </label>

        <button class="btn primary" id="btnLogin">Entrar</button>
        <button class="btn" id="btnRegister">Crear cuenta</button>
      </div>

      <div class="tip">
        ‚úÖ Consejo: usa siempre el mismo email y contrase√±a en todos tus m√≥viles/PC para compartir la misma nube.
      </div>
    </div>
  </section>

  <!-- APP -->
  <main class="app" id="app" hidden>
    <!-- NAV -->
    <nav class="tabs">
      <button class="tab active" data-tab="facturas">üìÑ Facturas</button>
      <button class="tab" data-tab="clientes">üë• Clientes</button>
      <button class="tab" data-tab="contabilidad">üìä Contabilidad</button>
      <button class="tab" data-tab="ajustes">‚öôÔ∏è Ajustes</button>
    </nav>

    <!-- FACTURAS -->
    <section class="panel show" id="tab-facturas">
      <div class="panelTop">
        <div>
          <h2>Facturas</h2>
          <div class="muted">Crear, editar, guardar PDF en nube, WhatsApp y control de pagos.</div>
        </div>

        <div class="panelActions">
          <button class="btn primary" id="btnNewInvoice">‚ûï Nueva factura</button>
          <button class="btn" id="btnNewFromTemplate">‚ú® Duplicar √∫ltima</button>
        </div>
      </div>

      <div class="filters">
        <div class="chipRow">
          <button class="chip active" data-filter="all">Todas</button>
          <button class="chip" data-filter="pendiente">Pendiente</button>
          <button class="chip" data-filter="parcial">Parcial</button>
          <button class="chip" data-filter="pagada">Pagada</button>
        </div>

        <div class="filterGrid">
          <label class="lbl">
            <span>Buscar</span>
            <input id="invSearch" type="text" placeholder="cliente / n√∫mero / tag..." />
          </label>

          <label class="lbl">
            <span>Cliente</span>
            <select id="invClientFilter"></select>
          </label>

          <label class="lbl">
            <span>Tag</span>
            <select id="invTagFilter"></select>
          </label>

          <label class="lbl">
            <span>Mes</span>
            <input id="invMonthFilter" type="month" />
          </label>
        </div>
      </div>

      <div class="tableCard">
        <table class="table" id="invoiceTable">
          <thead>
            <tr>
              <th>N¬∫</th>
              <th>Fecha</th>
              <th>Cliente</th>
              <th>Tags</th>
              <th>Estado</th>
              <th class="right">Total</th>
              <th class="right">Pagado</th>
              <th class="right">Pendiente</th>
              <th>PDF</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="invoiceTbody"></tbody>
        </table>
      </div>

      <!-- EDITOR FACTURA -->
      <section class="editorWrap" id="invoiceEditor" hidden>
        <div class="editorHeader">
          <div>
            <h3 id="edTitle">Factura</h3>
            <div class="muted" id="edSub">Edici√≥n completa ‚Äî tabla PRO</div>
          </div>
          <div class="editorActions">
            <button class="btn" id="btnEdClose">Cerrar</button>
            <button class="btn danger" id="btnEdDelete">Eliminar</button>
            <button class="btn primary" id="btnEdSave">Guardar</button>
          </div>
        </div>

        <div class="editorGrid">
          <div class="card">
            <h4>Datos</h4>
            <div class="grid2">
              <label class="lbl">
                <span>N¬∫ Factura</span>
                <input id="edNumber" type="text" placeholder="FA-YYYYMMDDHHMM" />
              </label>

              <label class="lbl">
                <span>Fecha</span>
                <input id="edDate" type="date" />
              </label>

              <label class="lbl">
                <span>Cliente</span>
                <select id="edClient"></select>
              </label>

              <label class="lbl">
                <span>Tags (separadas por coma)</span>
                <input id="edTags" type="text" placeholder="Centro, Severo..." />
              </label>

              <label class="lbl">
                <span>M√©todo pago</span>
                <select id="edMethod">
                  <option>Efectivo</option>
                  <option>Transferencia</option>
                  <option>Tarjeta</option>
                  <option>Bizum</option>
                </select>
              </label>

              <label class="lbl">
                <span>Estado</span>
                <select id="edStatus">
                  <option value="pendiente">pendiente</option>
                  <option value="parcial">parcial</option>
                  <option value="pagada">pagada</option>
                </select>
              </label>
            </div>

            <div class="grid2">
              <label class="lbl">
                <span>Transporte (‚Ç¨)</span>
                <input id="edTransport" type="number" inputmode="decimal" step="0.01" value="0" />
              </label>

              <label class="lbl">
                <span>IVA (%)</span>
                <input id="edIvaPct" type="number" inputmode="decimal" step="0.01" value="4" />
              </label>
            </div>

            <label class="lbl">
              <span>Observaciones</span>
              <input id="edNotes" type="text" placeholder="‚Äî" />
            </label>
          </div>

          <div class="card">
            <h4>Pagos</h4>
            <div class="payRow">
              <div class="metric">
                <div class="mLabel">Total</div>
                <div class="mValue" id="mTotal">0,00 ‚Ç¨</div>
              </div>
              <div class="metric">
                <div class="mLabel">Pagado</div>
                <div class="mValue ok" id="mPaid">0,00 ‚Ç¨</div>
              </div>
              <div class="metric">
                <div class="mLabel">Pendiente</div>
                <div class="mValue bad" id="mDue">0,00 ‚Ç¨</div>
              </div>
            </div>

            <div class="payGrid">
              <label class="lbl">
                <span>Importe pago</span>
                <input id="payAmount" type="number" inputmode="decimal" step="0.01" placeholder="0.00" />
              </label>
              <label class="lbl">
                <span>Fecha pago</span>
                <input id="payDate" type="date" />
              </label>
              <label class="lbl">
                <span>M√©todo</span>
                <select id="payMethod">
                  <option>Transferencia</option>
                  <option>Efectivo</option>
                  <option>Tarjeta</option>
                  <option>Bizum</option>
                </select>
              </label>
              <button class="btn" id="btnAddPayment">‚ûï A√±adir pago</button>
            </div>

            <div class="miniList" id="payList"></div>
          </div>
        </div>

        <div class="card">
          <div class="tableHead">
            <h4>Tabla de productos (PRO)</h4>
            <div class="tableActions">
              <button class="btn" id="btnAddLine">‚ûï L√≠nea</button>
              <button class="btn" id="btnAutoNet">üß† Neto auto</button>
              <button class="btn" id="btnMakePDFLocal">üìÑ PDF (local)</button>
              <button class="btn primary" id="btnMakePDFCloud">‚òÅÔ∏è Guardar PDF nube</button>
            </div>
          </div>

          <div class="tableScroll">
            <table class="table tiny" id="linesTable">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th>Modo</th>
                  <th class="right">Cant.</th>
                  <th class="right">Bruto</th>
                  <th class="right">Tara</th>
                  <th class="right">Neto</th>
                  <th class="right">Precio</th>
                  <th>Origen</th>
                  <th class="right">Importe</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="linesTbody"></tbody>
            </table>
          </div>
        </div>

        <div class="card">
          <div class="twoCols">
            <div>
              <h4>WhatsApp PRO</h4>
              <div class="muted">Enviar al cliente con PDF nube (si existe) o resumen.</div>
              <div class="grid2">
                <label class="lbl">
                  <span>Tel√©fono cliente</span>
                  <input id="waPhone" type="tel" placeholder="6XX XXX XXX" />
                </label>
                <label class="lbl">
                  <span>Mensaje</span>
                  <input id="waMsg" type="text" placeholder="Hola, te env√≠o la factura..." />
                </label>
              </div>
              <button class="btn" id="btnSendWA">üì≤ Enviar WhatsApp</button>
            </div>

            <div class="noteBox">
              <div class="noteTitle">‚úÖ Plantilla PDF</div>
              <div class="noteText">
                Igual a tu modelo: cabecera + tabla PRO + QR + totales + estado.
                El PDF se guarda en Storage y el link se queda en la nube junto con la factura.
              </div>
            </div>
          </div>
        </div>

      </section>
    </section>

    <!-- CLIENTES -->
    <section class="panel" id="tab-clientes">
      <div class="panelTop">
        <div>
          <h2>Clientes</h2>
          <div class="muted">Gesti√≥n de clientes + tags fijos + datos fiscales.</div>
        </div>
        <div class="panelActions">
          <button class="btn primary" id="btnNewClient">‚ûï Nuevo cliente</button>
        </div>
      </div>

      <div class="tableCard">
        <table class="table" id="clientsTable">
          <thead>
            <tr>
              <th>Nombre</th>
              <th>NIF/CIF</th>
              <th>Direcci√≥n</th>
              <th>Tel√©fono</th>
              <th>Email</th>
              <th>Tags</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="clientsTbody"></tbody>
        </table>
      </div>

      <section class="editorWrap" id="clientEditor" hidden>
        <div class="editorHeader">
          <div>
            <h3 id="clTitle">Cliente</h3>
            <div class="muted">Datos fiscales + tags PRO</div>
          </div>
          <div class="editorActions">
            <button class="btn" id="btnClClose">Cerrar</button>
            <button class="btn danger" id="btnClDelete">Eliminar</button>
            <button class="btn primary" id="btnClSave">Guardar</button>
          </div>
        </div>

        <div class="card">
          <div class="grid2">
            <label class="lbl">
              <span>Nombre fiscal</span>
              <input id="clName" type="text" />
            </label>
            <label class="lbl">
              <span>NIF/CIF</span>
              <input id="clNif" type="text" />
            </label>

            <label class="lbl">
              <span>Direcci√≥n</span>
              <input id="clAddr" type="text" />
            </label>
            <label class="lbl">
              <span>Ciudad / CP</span>
              <input id="clCity" type="text" placeholder="Burgos 09003" />
            </label>

            <label class="lbl">
              <span>Tel√©fono</span>
              <input id="clPhone" type="tel" />
            </label>
            <label class="lbl">
              <span>Email</span>
              <input id="clEmail" type="email" />
            </label>
          </div>

          <label class="lbl">
            <span>Tags fijos (separadas por coma)</span>
            <input id="clTags" type="text" placeholder="RIVIERA, Centro, VIP..." />
          </label>
        </div>
      </section>
    </section>

    <!-- CONTABILIDAD -->
    <section class="panel" id="tab-contabilidad">
      <div class="panelTop">
        <div>
          <h2>Contabilidad</h2>
          <div class="muted">Resumen mensual, pendiente total, ranking de clientes y tags.</div>
        </div>

        <div class="panelActions">
          <button class="btn" id="btnRefreshReports">üîÑ Actualizar</button>
        </div>
      </div>

      <div class="reportGrid">
        <div class="card">
          <h4>Resumen</h4>
          <div class="grid2">
            <label class="lbl">
              <span>Mes</span>
              <input id="repMonth" type="month" />
            </label>
            <label class="lbl">
              <span>Filtro Tag</span>
              <select id="repTag"></select>
            </label>
          </div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="kLabel">Ingresos</div>
              <div class="kValue" id="kIn">0,00 ‚Ç¨</div>
            </div>
            <div class="kpi">
              <div class="kLabel">Pagado</div>
              <div class="kValue ok" id="kPaid">0,00 ‚Ç¨</div>
            </div>
            <div class="kpi">
              <div class="kLabel">Pendiente</div>
              <div class="kValue bad" id="kDue">0,00 ‚Ç¨</div>
            </div>
          </div>

          <div class="miniHint">*Pendiente = total - pagado (incluye parciales).</div>
        </div>

        <div class="card">
          <h4>Ranking Clientes</h4>
          <div class="miniList" id="rankClients"></div>
        </div>

        <div class="card">
          <h4>Ranking Tags</h4>
          <div class="miniList" id="rankTags"></div>
        </div>
      </div>

      <div class="card">
        <h4>Facturas del mes</h4>
        <div class="tableCard">
          <table class="table">
            <thead>
              <tr>
                <th>N¬∫</th>
                <th>Cliente</th>
                <th>Estado</th>
                <th class="right">Total</th>
                <th class="right">Pagado</th>
                <th class="right">Pendiente</th>
              </tr>
            </thead>
            <tbody id="repTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- AJUSTES -->
    <section class="panel" id="tab-ajustes">
      <div class="panelTop">
        <div>
          <h2>Ajustes</h2>
          <div class="muted">Configura proveedor, IVA por defecto, plantilla de numeraci√≥n, etc.</div>
        </div>
      </div>

      <div class="card">
        <h4>Proveedor (sale en el PDF)</h4>
        <div class="grid2">
          <label class="lbl">
            <span>Nombre</span>
            <input id="setSupName" type="text" />
          </label>
          <label class="lbl">
            <span>NIF</span>
            <input id="setSupNif" type="text" />
          </label>
          <label class="lbl">
            <span>Direcci√≥n</span>
            <input id="setSupAddr" type="text" />
          </label>
          <label class="lbl">
            <span>Tel√©fono</span>
            <input id="setSupTel" type="text" />
          </label>
          <label class="lbl">
            <span>Email</span>
            <input id="setSupEmail" type="text" />
          </label>
          <label class="lbl">
            <span>IVA por defecto (%)</span>
            <input id="setIvaDefault" type="number" step="0.01" />
          </label>
        </div>

        <div class="grid2">
          <label class="lbl">
            <span>Plantilla N¬∫ factura</span>
            <input id="setNumberTpl" type="text" placeholder="FA-YYYYMMDDHHMM" />
          </label>
          <label class="lbl">
            <span>Texto PDF (abajo)</span>
            <input id="setPdfNote" type="text" placeholder="IVA incluido en los precios." />
          </label>
        </div>

        <div class="rowEnd">
          <button class="btn primary" id="btnSaveSettings">Guardar ajustes</button>
        </div>
      </div>

      <div class="card">
        <h4>Herramientas</h4>
        <div class="toolsGrid">
          <button class="btn" id="btnResetLocal">üßπ Limpiar local (NO nube)</button>
          <button class="btn danger" id="btnDangerWipeCloud">‚ö†Ô∏è Borrar nube (ADMIN)</button>
        </div>
        <div class="miniHint">‚ö†Ô∏è ‚ÄúBorrar nube‚Äù elimina facturas/clientes del usuario logueado.</div>
      </div>
    </section>

    <!-- TOAST -->
    <div class="toast" id="toast" hidden></div>

    <!-- FLOAT -->
    <button class="fab" id="fabNew" title="Nueva factura">‚ûï</button>
  </main>

  <input type="file" id="fileImport" accept="application/json" hidden />

  <!-- APP (module) -->
  <script type="module" src="./app.js"></script>
</body>
</html>
