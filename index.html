<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffffff" />
  <title>ARSLAN • FACTURAS — KIWI EDITION</title>

  <!-- PWA -->
  <link rel="manifest" href="./manifest.json" />

  <!-- Font (simple, pro) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />
</head>

<body>
  <header class="topbar">
    <div class="brand">
      <div class="dot"></div>
      <div class="brand-txt">
        <div class="brand-title">ARSLAN • FACTURAS</div>
        <div class="brand-sub">KIWI EDITION — B/W • Offline-first • Cloud opcional</div>
      </div>
    </div>

    <div class="top-actions">
      <div class="pill status" id="modePill">Modo local</div>
      <button class="btn btn-ghost" id="btnSync" title="Sync ahora (si Cloud activo)">Sync ahora</button>
      <button class="btn btn-ghost" id="btnAuth" title="Login/Logout">Cloud</button>
    </div>
  </header>

  <nav class="tabs" aria-label="Secciones">
    <button class="tab active" data-view="invoicesView">Facturas</button>
    <button class="tab" data-view="clientsView">Clientes</button>
    <button class="tab" data-view="productsView">Productos</button>
    <button class="tab" data-view="accountingView">Contabilidad</button>
    <button class="tab" data-view="settingsView">Ajustes</button>
  </nav>

  <main class="app">
    <!-- =========================
         FACTURAS
    ========================== -->
    <section class="view active" id="invoicesView">
      <div class="split">
        <!-- LISTA -->
        <aside class="panel listPanel">
          <div class="panelHead">
            <div class="hgroup">
              <h2>Facturas</h2>
              <p class="muted">Buscar, crear, duplicar, PDF, WhatsApp.</p>
            </div>
            <button class="btn" id="btnNewInvoice">+ Nueva</button>
          </div>

          <div class="row gap">
            <input id="invoiceSearch" class="input" placeholder="Buscar: Nº / cliente / tag" autocomplete="off" />
            <button class="btn btn-ghost" id="btnExportJSON" title="Exportar backup JSON">Export</button>
            <button class="btn btn-ghost" id="btnImportJSON" title="Importar JSON">Import</button>
            <input type="file" id="fileImport" accept="application/json" hidden />
          </div>

          <div class="listMeta" id="invoiceListMeta">0 facturas</div>

          <div class="list" id="invoiceList" aria-label="Listado de facturas">
            <!-- items render -->
          </div>

          <div class="footnote">
            <span class="kbd">Ctrl+S</span> Guardar · <span class="kbd">Ctrl+P</span> PDF · <span class="kbd">/</span> Buscar
          </div>
        </aside>

        <!-- EDITOR -->
        <section class="panel editorPanel">
          <div class="panelHead sticky">
            <div class="hgroup">
              <h2 id="editorTitle">Editor de factura</h2>
              <p class="muted" id="editorSubtitle">Selecciona una factura o crea una nueva.</p>
            </div>

            <div class="row actionsRight">
              <button class="btn btn-ghost" id="btnDuplicate">Duplicar</button>
              <button class="btn btn-ghost" id="btnDelete">Eliminar</button>
              <button class="btn" id="btnSave">Guardar</button>
            </div>
          </div>

          <!-- CABECERA PRO -->
          <div class="invoiceHeader">
            <div class="card">
              <div class="cardTitle">Proveedor</div>
              <div class="grid2">
                <input class="input" id="prov_name" placeholder="Nombre" />
                <input class="input" id="prov_nif" placeholder="NIF" />
                <input class="input" id="prov_addr" placeholder="Dirección" />
                <input class="input" id="prov_tel" placeholder="Teléfono" />
                <input class="input" id="prov_email" placeholder="Email" />
                <div class="hint">Editable. Se guarda en Ajustes.</div>
              </div>
            </div>

            <div class="card centerCard">
              <div class="cardTitle">QR AEAT</div>
              <div class="qrBox">
                <div id="qrMount" class="qrMount" aria-label="QR factura"></div>
                <div class="hint" id="qrHint">Si falla la librería QR, la factura sigue funcionando.</div>
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">Cliente</div>
              <div class="grid2">
                <select class="input" id="client_select">
                  <option value="">— Seleccionar cliente —</option>
                </select>
                <button class="btn btn-ghost" id="btnOpenClient">Abrir</button>

                <input class="input" id="cli_name" placeholder="Nombre fiscal / Alias" />
                <input class="input" id="cli_nif" placeholder="NIF/CIF" />
                <input class="input" id="cli_addr" placeholder="Dirección" />
                <input class="input" id="cli_tel" placeholder="Teléfono" />
                <input class="input" id="cli_email" placeholder="Email" />
                <div class="hint">Se rellena al elegir cliente. Puedes editar en la factura.</div>
              </div>
            </div>
          </div>

          <!-- META -->
          <div class="metaRow">
            <div class="metaCard">
              <label class="lbl">Nº factura</label>
              <input class="input mono" id="inv_number" placeholder="FA-YYYYMMDDHHMM" readonly />
              <div class="hint">Auto. Puedes duplicar y se regenera.</div>
            </div>
            <div class="metaCard">
              <label class="lbl">Fecha</label>
              <input type="date" class="input" id="inv_date" />
              <div class="hint">Afecta listados y contabilidad.</div>
            </div>
            <div class="metaCard">
              <label class="lbl">Tags</label>
              <input class="input" id="inv_tags" placeholder="Ej: RIVIERA, CENTRO, ENERO" />
              <div class="hint">Separados por coma.</div>
            </div>
            <div class="metaCard">
              <label class="lbl">Notas</label>
              <input class="input" id="inv_notes" placeholder="Notas internas / pie opcional" />
              <div class="hint">Se guarda en BD.</div>
            </div>
          </div>

          <!-- GRID PRO -->
          <div class="gridWrap">
            <div class="gridTop">
              <div class="gridTitle">Cuadro de cálculo</div>
              <div class="row gap">
                <button class="btn btn-ghost" id="btnAddLine">+ Añadir línea</button>
                <button class="btn btn-ghost" id="btnClearLines">Vaciar</button>
                <button class="btn btn-ghost" id="btnWhats">WhatsApp TXT</button>
                <button class="btn" id="btnPDF">PDF</button>
              </div>
            </div>

            <div class="table" role="table" aria-label="Líneas de factura">
              <div class="tr th" role="row">
                <div class="td col-prod">Producto</div>
                <div class="td col-mode">Modo</div>
                <div class="td col-qty">Cant.</div>
                <div class="td col-bruto">Kg/Bruto</div>
                <div class="td col-tara">Tara</div>
                <div class="td col-neto">Neto</div>
                <div class="td col-price">Precio</div>
                <div class="td col-origin">Origen</div>
                <div class="td col-amt">Importe</div>
                <div class="td col-x">X</div>
              </div>

              <div id="linesBody" class="tbody" role="rowgroup">
                <!-- rows render -->
              </div>
            </div>

            <template id="rowTpl">
              <div class="tr" role="row">
                <div class="td col-prod">
                  <input class="input prodInput" placeholder="Producto…" autocomplete="off" />
                  <div class="hint tiny hintPrice"></div>
                </div>
                <div class="td col-mode">
                  <select class="input modeSel">
                    <option value="kg">kg</option>
                    <option value="caja">caja</option>
                    <option value="ud">unidad</option>
                  </select>
                </div>
                <div class="td col-qty">
                  <input class="input num qty" inputmode="decimal" placeholder="0" />
                </div>
                <div class="td col-bruto">
                  <input class="input num bruto" inputmode="decimal" placeholder="0" />
                </div>
                <div class="td col-tara">
                  <input class="input num tara" inputmode="decimal" placeholder="0" />
                </div>
                <div class="td col-neto">
                  <input class="input num neto" inputmode="decimal" placeholder="0" readonly />
                </div>
                <div class="td col-price">
                  <input class="input num price" inputmode="decimal" placeholder="0" />
                </div>
                <div class="td col-origin">
                  <input class="input origin" placeholder="Origen" />
                </div>
                <div class="td col-amt">
                  <div class="amt mono">0,00</div>
                </div>
                <div class="td col-x">
                  <button class="btn btn-ghost btnX" title="Borrar línea">×</button>
                </div>
              </div>
            </template>
          </div>

          <!-- TOTALES / PAGOS -->
          <div class="bottomGrid">
            <div class="card">
              <div class="cardTitle">Totales</div>

              <div class="totRow">
                <div class="totLbl">Subtotal</div>
                <div class="totVal mono" id="tot_sub">0,00</div>
              </div>

              <div class="totRow">
                <div class="totLbl">
                  Transporte
                  <span class="muted tiny" id="shipPctLabel">0%</span>
                </div>
                <div class="totVal mono" id="tot_ship">0,00</div>
              </div>

              <div class="totRow">
                <div class="totLbl">
                  IVA
                  <span class="muted tiny" id="vatModeLabel">4%</span>
                </div>
                <div class="totVal mono" id="tot_vat">0,00</div>
              </div>

              <div class="totRow strong">
                <div class="totLbl">TOTAL</div>
                <div class="totVal mono" id="tot_all">0,00</div>
              </div>

              <div class="row gap mt">
                <label class="chk">
                  <input type="checkbox" id="chkShip" />
                  Transporte
                </label>
                <label class="chk">
                  <input type="checkbox" id="chkVatIncluded" />
                  IVA incluido en precios
                </label>
                <label class="chk">
                  <input type="checkbox" id="chkAutoSync" />
                  Auto-sync (Cloud)
                </label>
              </div>

              <div class="hint mt">
                Últimos precios solo como “hint” en pantalla. Nunca se imprimen.
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">Pagos</div>

              <div class="row gap">
                <select class="input" id="pay_method">
                  <option value="efectivo">Efectivo</option>
                  <option value="transferencia">Transferencia</option>
                  <option value="tarjeta">Tarjeta</option>
                </select>
                <input class="input num" id="pay_amount" inputmode="decimal" placeholder="Importe" />
                <button class="btn btn-ghost" id="btnAddPay">+ Añadir</button>
              </div>

              <div class="payList" id="payList">
                <!-- render -->
              </div>

              <div class="totRow">
                <div class="totLbl">Pagado</div>
                <div class="totVal mono" id="paid_total">0,00</div>
              </div>

              <div class="totRow strong">
                <div class="totLbl">Pendiente</div>
                <div class="totVal mono" id="due_total">0,00</div>
              </div>

              <div class="row gap mt">
                <div class="pill" id="invStatusPill">Impagada</div>
                <label class="chk">
                  <input type="checkbox" id="chkClosed" />
                  Cerrada (no reescribir precios)
                </label>
              </div>

              <div class="hint mt">
                Estado: Impagada / Parcial / Pagada (auto según pagos).
              </div>
            </div>

            <div class="card">
              <div class="cardTitle">PDF / Links</div>

              <div class="row gap">
                <button class="btn btn-ghost" id="btnOpenPDF" disabled>Abrir PDF</button>
                <button class="btn btn-ghost" id="btnCopyPDF" disabled>Copiar link</button>
              </div>

              <div class="hint mt">
                PDF se guarda en local (IndexedDB) y, si Cloud activo, también en Storage.
              </div>

              <div class="mono tiny mt" id="pdfMeta"></div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <!-- =========================
         CLIENTES
    ========================== -->
    <section class="view" id="clientsView">
      <div class="panel">
        <div class="panelHead">
          <div class="hgroup">
            <h2>Clientes</h2>
            <p class="muted">Alta/edición/borrado, tags, búsqueda.</p>
          </div>
          <button class="btn" id="btnNewClient">+ Nuevo cliente</button>
        </div>

        <div class="row gap">
          <input id="clientSearch" class="input" placeholder="Buscar cliente…" autocomplete="off" />
          <button class="btn btn-ghost" id="btnClientsExport">Export</button>
        </div>

        <div class="clientsGrid">
          <div class="list" id="clientsList"></div>

          <div class="card" id="clientEditor">
            <div class="cardTitle">Editor</div>
            <div class="grid2">
              <input class="input" id="c_name" placeholder="Nombre fiscal" />
              <input class="input" id="c_alias" placeholder="Alias (opcional)" />
              <input class="input" id="c_nif" placeholder="NIF/CIF" />
              <input class="input" id="c_tags" placeholder="Tags (coma)" />
              <input class="input" id="c_addr" placeholder="Dirección" />
              <input class="input" id="c_tel" placeholder="Teléfono" />
              <input class="input" id="c_email" placeholder="Email" />

              <label class="chk">
                <input type="checkbox" id="c_vatIncluded" />
                IVA incluido en precios (este cliente)
              </label>

              <label class="chk">
                <input type="checkbox" id="c_shipOn" />
                Transporte por defecto (este cliente)
              </label>
            </div>

            <div class="row gap mt">
              <button class="btn" id="btnClientSave">Guardar</button>
              <button class="btn btn-ghost" id="btnClientDelete">Eliminar</button>
              <div class="hint">El selector de factura se rellena automáticamente.</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================
         PRODUCTOS
    ========================== -->
    <section class="view" id="productsView">
      <div class="panel">
        <div class="panelHead">
          <div class="hgroup">
            <h2>Productos</h2>
            <p class="muted">Catálogo + unidad por defecto + kg/caja + precio + coste + historial.</p>
          </div>
          <button class="btn" id="btnNewProduct">+ Nuevo producto</button>
        </div>

        <div class="row gap">
          <input id="productSearch" class="input" placeholder="Buscar producto…" autocomplete="off" />
          <button class="btn btn-ghost" id="btnProductsExport">Export</button>
        </div>

        <div class="productsGrid">
          <div class="list" id="productsList"></div>

          <div class="card" id="productEditor">
            <div class="cardTitle">Editor</div>
            <div class="grid2">
              <input class="input" id="p_name" placeholder="Nombre producto" />
              <select class="input" id="p_unit">
                <option value="kg">kg</option>
                <option value="caja">caja</option>
                <option value="ud">unidad</option>
              </select>
              <input class="input num" id="p_kgBox" inputmode="decimal" placeholder="Kg por caja (si aplica)" />
              <input class="input num" id="p_price" inputmode="decimal" placeholder="Precio actual" />
              <input class="input num" id="p_cost" inputmode="decimal" placeholder="Coste (margen)" />
              <input class="input" id="p_origin" placeholder="Origen por defecto (opcional)" />
            </div>

            <div class="historyBox">
              <div class="muted tiny">Historial (últimas 5) — solo pantalla</div>
              <div class="mono tiny" id="p_hist">—</div>
            </div>

            <div class="row gap mt">
              <button class="btn" id="btnProductSave">Guardar</button>
              <button class="btn btn-ghost" id="btnProductDelete">Eliminar</button>
              <div class="hint">Cambiar precio añade una entrada al historial (con fecha).</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- =========================
         CONTABILIDAD (PIN)
    ========================== -->
    <section class="view" id="accountingView">
      <div class="panel">
        <div class="panelHead">
          <div class="hgroup">
            <h2>Contabilidad</h2>
            <p class="muted">Protegida con PIN. KPIs + filtros + tabla detalle.</p>
          </div>
          <button class="btn" id="btnUnlock">Desbloquear</button>
        </div>

        <div class="lockBox" id="lockBox">
          <div class="muted">Bloqueado. Introduce PIN para ver datos.</div>
        </div>

        <div class="accountingBody" id="accountingBody" hidden>
          <div class="row gap">
            <label class="lbl">Desde <input type="date" class="input" id="acc_from" /></label>
            <label class="lbl">Hasta <input type="date" class="input" id="acc_to" /></label>
            <select class="input" id="acc_client"><option value="">— Cliente —</option></select>
            <input class="input" id="acc_tag" placeholder="Tag (opcional)" />
            <button class="btn btn-ghost" id="btnAccApply">Aplicar</button>
          </div>

          <div class="kpiGrid">
            <div class="kpi">
              <div class="muted tiny">Ventas</div>
              <div class="mono big" id="kpi_sales">0,00</div>
            </div>
            <div class="kpi">
              <div class="muted tiny">IVA</div>
              <div class="mono big" id="kpi_vat">0,00</div>
            </div>
            <div class="kpi">
              <div class="muted tiny">Nº facturas</div>
              <div class="mono big" id="kpi_count">0</div>
            </div>
            <div class="kpi">
              <div class="muted tiny">Margen estimado</div>
              <div class="mono big" id="kpi_margin">0,00</div>
            </div>
          </div>

          <div class="list" id="accTable"></div>
        </div>
      </div>
    </section>

    <!-- =========================
         AJUSTES
    ========================== -->
    <section class="view" id="settingsView">
      <div class="panel">
        <div class="panelHead">
          <div class="hgroup">
            <h2>Ajustes</h2>
            <p class="muted">Proveedor por defecto, IVA, transporte, QR, Firebase, reset.</p>
          </div>
        </div>

        <div class="settingsGrid">
          <div class="card">
            <div class="cardTitle">IVA / Transporte</div>
            <div class="grid2">
              <label class="lbl">IVA % <input class="input num" id="set_vat" inputmode="decimal" placeholder="4" /></label>
              <label class="lbl">Transporte % <input class="input num" id="set_ship" inputmode="decimal" placeholder="10" /></label>
              <label class="chk">
                <input type="checkbox" id="set_vatIncludedDefault" />
                IVA incluido por defecto
              </label>
            </div>
            <div class="row gap mt">
              <button class="btn" id="btnSettingsSave">Guardar ajustes</button>
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">QR AEAT</div>
            <label class="lbl">Plantilla QR</label>
            <textarea class="input mono" id="set_qrTpl" rows="5"
              placeholder="AEAT|NIF={NIF}|NUM={NUM}|FECHA={FECHA}|TOTAL={TOTAL}"></textarea>
            <div class="hint">
              Variables: {NIF} {NUM} {FECHA} {TOTAL}
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">Cloud (Firebase opcional)</div>
            <div class="grid2">
              <input class="input mono" id="fb_apiKey" placeholder="apiKey" />
              <input class="input mono" id="fb_authDomain" placeholder="authDomain" />
              <input class="input mono" id="fb_databaseURL" placeholder="databaseURL" />
              <input class="input mono" id="fb_projectId" placeholder="projectId" />
              <input class="input mono" id="fb_appId" placeholder="appId" />
              <input class="input mono" id="fb_storageBucket" placeholder="storageBucket" />
            </div>
            <div class="row gap mt">
              <button class="btn btn-ghost" id="btnTestCloud">Probar Cloud</button>
              <button class="btn" id="btnSaveCloud">Guardar Cloud</button>
            </div>
            <div class="hint mt" id="cloudHint">
              Si falla (PERMISSION_DENIED) → modo local sin romper.
            </div>
          </div>

          <div class="card">
            <div class="cardTitle">Link externo “Poner precios”</div>
            <div class="hint">
              Te entregaré un segundo mini-proyecto (otra carpeta) para que otra persona ponga precios desde móvil.
            </div>
            <div class="mono tiny mt" id="pricesLinkInfo">—</div>
          </div>

          <div class="card danger">
            <div class="cardTitle">Reset</div>
            <div class="hint">
              Limpia datos locales (no borra nube). Requiere confirmación.
            </div>
            <div class="row gap mt">
              <button class="btn btn-ghost" id="btnResetLocal">Reset local</button>
              <button class="btn btn-ghost" id="btnHardReset">Reset TOTAL</button>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- =========================
       MODAL: AUTH (CLOUD)
  ========================== -->
  <dialog class="modal" id="authModal">
    <form method="dialog" class="modalCard">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Cloud</div>
          <div class="muted tiny">Login/Signup (Email/Password) — opcional</div>
        </div>
        <button class="btn btn-ghost" value="cancel">×</button>
      </div>

      <div class="grid2">
        <input class="input" id="auth_email" type="email" placeholder="Email" />
        <input class="input" id="auth_pass" type="password" placeholder="Password" />
      </div>

      <div class="row gap mt">
        <button class="btn" id="btnLogin" value="default">Login</button>
        <button class="btn btn-ghost" id="btnSignup" value="default">Signup</button>
        <button class="btn btn-ghost" id="btnLogout" value="default">Logout</button>
      </div>

      <div class="hint mt" id="authMsg">—</div>
    </form>
  </dialog>

  <!-- =========================
       MODAL: PIN (CONTABILIDAD)
  ========================== -->
  <dialog class="modal" id="pinModal">
    <form method="dialog" class="modalCard">
      <div class="modalHead">
        <div>
          <div class="modalTitle">PIN Contabilidad</div>
          <div class="muted tiny">Acceso protegido</div>
        </div>
        <button class="btn btn-ghost" value="cancel">×</button>
      </div>

      <input class="input mono" id="pinInput" inputmode="numeric" type="password" placeholder="PIN" />

      <div class="row gap mt">
        <button class="btn" id="btnPinOk" value="default">Entrar</button>
        <button class="btn btn-ghost" value="cancel">Cancelar</button>
      </div>

      <div class="hint mt" id="pinMsg">—</div>
    </form>
  </dialog>

  <!-- TOAST -->
  <div class="toast" id="toast" hidden></div>

  <noscript>
    <div style="padding:16px;font-family:system-ui">
      Necesitas activar JavaScript para usar ARSLAN • FACTURAS.
    </div>
  </noscript>

  <script type="module" src="./app.js"></script>
</body>
</html>
