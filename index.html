<!-- =========================================================
PARTE 1/5 ‚Äî FACTU MIRAL (B/W PRO)
Archivo: index.html  (COMPLETO)
- Reglas: Offline primero + Cloud opcional + B/W PRO + Facturas editables + QR + PDF visor
========================================================= -->
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111111" />
  <title>FACTU MIRAL ‚Äî B/W PRO</title>

  <!-- Tipograf√≠a: r√°pida y limpia -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Estilos -->
  <link rel="stylesheet" href="./style.css" />

  <!-- PDF libs (opcionales; el sistema avisa si no cargan) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

  <!-- App -->
  <script defer src="./app.js"></script>
</head>

<body>
  <!-- =========================================================
  APP SHELL
  ========================================================== -->
  <div id="app" class="app">

    <!-- TOP BAR -->
    <header class="topbar">
      <div class="brand">
        <div class="brandLogo" aria-hidden="true" title="Factu Miral">
          <!-- Logo cereza (B/W) -->
          <svg class="cherry" viewBox="0 0 128 128" role="img" aria-label="Cereza">
            <path d="M78 26c12-10 26-12 40-6" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <path d="M66 28c-2-12 2-22 14-26" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <path d="M76 28c-6 18-8 34-6 50" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <path d="M52 36c-10 16-14 32-12 48" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
            <circle cx="50" cy="90" r="22" fill="none" stroke="currentColor" stroke-width="6"/>
            <circle cx="84" cy="88" r="22" fill="none" stroke="currentColor" stroke-width="6"/>
            <path d="M46 66c-12-10-18-22-18-36" fill="none" stroke="currentColor" stroke-width="6" stroke-linecap="round"/>
          </svg>
        </div>

        <div class="brandText">
          <div class="brandTitle">FACTU MIRAL</div>
          <div class="brandSub">B/W PRO ¬∑ Offline primero ¬∑ Cloud opcional</div>
        </div>
      </div>

      <div class="topActions">
        <div class="pill" id="pillLocal" title="Estado Local">
          <span class="dot ok" id="dotLocal"></span>
          <span class="pillTxt">Local OK</span>
        </div>
        <div class="pill" id="pillCloud" title="Estado Cloud (opcional)">
          <span class="dot off" id="dotCloud"></span>
          <span class="pillTxt" id="cloudText">Cloud OFF</span>
        </div>

        <button class="btn btnGhost" id="btnQuickSearch" type="button" title="Ctrl+F Buscar (en listados)">
          Buscar
        </button>

        <button class="btn btnGhost" id="btnLockPanel" type="button" title="Bloquear/Desbloquear paneles protegidos (PIN)">
          üîí PIN
        </button>
      </div>
    </header>

    <!-- NAV TABS -->
    <nav class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab isActive" data-tab="tabFactura" role="tab" aria-selected="true" type="button">Factura</button>
      <button class="tab" data-tab="tabFacturas" role="tab" aria-selected="false" type="button">Facturas</button>
      <button class="tab" data-tab="tabClientes" role="tab" aria-selected="false" type="button">Clientes</button>
      <button class="tab" data-tab="tabProductos" role="tab" aria-selected="false" type="button">Productos</button>
      <button class="tab" data-tab="tabTaras" role="tab" aria-selected="false" type="button">Taras</button>

      <button class="tab tabLocked" data-tab="tabContabilidad" role="tab" aria-selected="false" type="button">
        Contabilidad <span class="lockBadge">üîí</span>
      </button>
      <button class="tab tabLocked" data-tab="tabVentas" role="tab" aria-selected="false" type="button">
        Ventas <span class="lockBadge">üîí</span>
      </button>

      <button class="tab" data-tab="tabAjustes" role="tab" aria-selected="false" type="button">Ajustes</button>
    </nav>

    <!-- MAIN -->
    <main class="main">
      <!-- =========================================================
      TAB: FACTURA (principal)
      ========================================================== -->
      <section id="tabFactura" class="tabPage isActive" role="tabpanel" aria-label="Factura">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Factura</h1>
            <div class="muted">Edici√≥n total ¬∑ C√°lculos correctos kg/caja/ud ¬∑ Taras autom√°ticas ¬∑ PDF PRO</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn" id="btnNuevaFactura" type="button">+ Nueva factura</button>
            <button class="btn btnGhost" id="btnDuplicarFactura" type="button">Duplicar</button>
            <button class="btn btnDangerGhost" id="btnEliminarFactura" type="button">Eliminar</button>
          </div>
        </div>

        <!-- ACCIONES PRINCIPALES -->
        <div class="actionBar">
          <button class="btn" id="btnGuardarFactura" type="button">Guardar</button>
          <button class="btn btnGhost" id="btnGenerarPDF" type="button">Generar PDF</button>
          <button class="btn btnGhost" id="btnVerPDF" type="button">Ver PDF</button>
          <button class="btn btnGhost" id="btnPdfNube" type="button" title="Subir PDF a la nube si est√° configurada">PDF + Nube</button>
          <button class="btn btnGhost" id="btnWhatsapp" type="button">WhatsApp</button>
        </div>

        <!-- LAYOUT FACTURA PRO: Proveedor izquierda / QR centro / Cliente derecha -->
        <div class="invoiceHeaderPro">
          <!-- PROVEEDOR -->
          <section class="card cardTight">
            <div class="cardTitleRow">
              <h2 class="h2">Proveedor</h2>
              <button class="btn btnTiny btnGhost" id="btnGuardarProveedor" type="button" title="Guardar proveedor en Ajustes">
                Guardar
              </button>
            </div>

            <div class="grid2">
              <label class="field">
                <span>Nombre</span>
                <input id="provNombre" type="text" autocomplete="organization" />
              </label>
              <label class="field">
                <span>NIF</span>
                <input id="provNif" type="text" autocomplete="off" />
              </label>
              <label class="field col2">
                <span>Direcci√≥n</span>
                <input id="provDir" type="text" autocomplete="street-address" />
              </label>
              <label class="field">
                <span>Tel√©fono</span>
                <input id="provTel" type="tel" autocomplete="tel" />
              </label>
              <label class="field">
                <span>Email</span>
                <input id="provEmail" type="email" autocomplete="email" />
              </label>
            </div>
          </section>

          <!-- QR AEAT -->
          <section class="card cardTight qrCard">
            <div class="cardTitleRow">
              <h2 class="h2">QR</h2>
              <div class="miniRow">
                <button class="btn btnTiny btnGhost" id="btnCopiarTextoQR" type="button">Copiar texto</button>
              </div>
            </div>

            <div class="qrWrap">
              <div class="qrCanvasWrap" aria-label="QR tributario">
                <canvas id="qrCanvas" width="220" height="220"></canvas>
                <div class="qrFallback" id="qrFallback">
                  QR no generado (faltan datos o error)
                </div>
              </div>

              <div class="qrMeta">
                <div class="muted small">Texto QR (si falla el escaneo):</div>
                <textarea id="qrText" rows="5" spellcheck="false"></textarea>
                <div class="hint small" id="qrHint">
                  Requiere: NIF proveedor + N¬∫ factura + fecha + total.
                </div>
              </div>
            </div>
          </section>

          <!-- CLIENTE -->
          <section class="card cardTight">
            <div class="cardTitleRow">
              <h2 class="h2">Cliente</h2>
              <div class="miniRow">
                <button class="btn btnTiny" id="btnNuevoClienteDesdeFactura" type="button">+ Nuevo</button>
                <button class="btn btnTiny btnGhost" id="btnGuardarClienteDesdeFactura" type="button">Guardar</button>
              </div>
            </div>

            <label class="field">
              <span>Seleccionar cliente</span>
              <select id="selCliente">
                <option value="">‚Äî Selecciona ‚Äî</option>
              </select>
            </label>

            <div class="grid2">
              <label class="field">
                <span>Nombre</span>
                <input id="cliNombre" type="text" autocomplete="name" />
              </label>
              <label class="field">
                <span>NIF/CIF</span>
                <input id="cliNif" type="text" autocomplete="off" />
              </label>
              <label class="field col2">
                <span>Direcci√≥n</span>
                <input id="cliDir" type="text" autocomplete="street-address" />
              </label>
              <label class="field">
                <span>Tel√©fono</span>
                <input id="cliTel" type="tel" autocomplete="tel" />
              </label>
              <label class="field">
                <span>Email</span>
                <input id="cliEmail" type="email" autocomplete="email" />
              </label>
            </div>
          </section>
        </div>

        <!-- METADATOS FACTURA -->
        <section class="card">
          <div class="cardTitleRow">
            <h2 class="h2">Datos de factura</h2>
            <div class="miniRow">
              <span class="muted small">N¬∫ auto:</span>
              <span class="mono badge" id="factNumero">FA-‚Äî</span>
            </div>
          </div>

          <div class="grid3">
            <label class="field">
              <span>N¬∫ factura</span>
              <input id="inpNumeroFactura" type="text" spellcheck="false" />
            </label>

            <label class="field">
              <span>Fecha</span>
              <input id="inpFechaFactura" type="date" />
              <div class="hint small">Se guarda ISO ¬∑ Se muestra dd/mm/aaaa en PDF/WhatsApp.</div>
            </label>

            <label class="field">
              <span>Tags</span>
              <input id="inpTags" type="text" placeholder="Ej: San Pablo, urgente, tienda..." />
              <div class="hint small">Multi-etiqueta (separar por coma).</div>
            </label>

            <label class="field col3">
              <span>Notas internas</span>
              <input id="inpNotasInternas" type="text" placeholder="Solo interno (no cliente)" />
            </label>

            <label class="field col3">
              <span>Observaciones (cliente)</span>
              <textarea id="inpObservaciones" rows="3" placeholder="Observaciones que aparecer√°n en el PDF"></textarea>
            </label>
          </div>
        </section>

        <!-- GRID PRO -->
        <section class="card">
          <div class="cardTitleRow">
            <h2 class="h2">L√≠neas</h2>
            <div class="miniRow">
              <button class="btn btnTiny" id="btnAddLinea" type="button">+ A√±adir l√≠nea</button>
              <button class="btn btnTiny btnGhost" id="btnVaciarLineas" type="button">Vaciar a 5</button>
            </div>
          </div>

          <div class="gridProWrap">
            <div class="gridProHeader">
              <div class="gCell">Producto</div>
              <div class="gCell">Modo</div>
              <div class="gCell">Cantidad</div>
              <div class="gCell">Bruto (kg)</div>
              <div class="gCell">Envase/Tara</div>
              <div class="gCell">N¬∫ env.</div>
              <div class="gCell">Tara (kg)</div>
              <div class="gCell">Neto (kg)</div>
              <div class="gCell">Precio</div>
              <div class="gCell">Origen</div>
              <div class="gCell">Importe</div>
              <div class="gCell">‚úñ</div>
            </div>

            <!-- Filas renderizadas por app.js -->
            <div id="gridProBody" class="gridProBody" aria-label="L√≠neas de factura"></div>

            <div class="gridLegend">
              <div class="muted small">
                ‚úÖ <b>Modo KG:</b> Tara total = N¬∫ envases √ó tara unidad (o manual) ¬∑ Neto = Bruto ‚àí Tara ¬∑ Importe = Neto √ó Precio/kg
                <br/>
                ‚úÖ <b>Enter:</b> avanza campos ¬∑ al final crea nueva l√≠nea.
              </div>
            </div>
          </div>
        </section>

        <!-- TOTALES -->
        <section class="card totalsCard">
          <div class="cardTitleRow">
            <h2 class="h2">Totales</h2>
            <div class="miniRow">
              <label class="check">
                <input id="chkTransporte" type="checkbox" />
                <span>Transporte</span>
              </label>

              <label class="check">
                <input id="chkIvaIncluido" type="checkbox" />
                <span>IVA incluido (sin desglose)</span>
              </label>

              <button class="btn btnTiny btnGhost" id="btnAddIva4" type="button" title="A√±adir 4% IVA al total (acci√≥n r√°pida)">
                + IVA 4%
              </button>
            </div>
          </div>

          <div class="totalsGrid">
            <div class="totRow">
              <span class="muted">Subtotal</span>
              <span class="mono" id="totSubtotal">0,00 ‚Ç¨</span>
            </div>

            <div class="totRow" id="rowTransporte">
              <span class="muted">Transporte</span>
              <span class="mono" id="totTransporte">0,00 ‚Ç¨</span>
            </div>

            <div class="totRow" id="rowIva">
              <span class="muted">IVA</span>
              <span class="mono" id="totIva">0,00 ‚Ç¨</span>
            </div>

            <div class="totRow totBig">
              <span><b>TOTAL</b></span>
              <span class="mono" id="totTotal">0,00 ‚Ç¨</span>
            </div>

            <div class="totRow">
              <span class="muted">Pendiente</span>
              <span class="mono" id="totPendiente">0,00 ‚Ç¨</span>
            </div>
          </div>

          <!-- PAGOS -->
          <div class="paymentsWrap">
            <div class="paymentsHead">
              <h3 class="h3">Pagos</h3>
              <div class="miniRow">
                <label class="fieldInline">
                  <span>Importe</span>
                  <input id="pagoImporte" type="number" inputmode="decimal" step="0.01" />
                </label>
                <label class="fieldInline">
                  <span>Fecha</span>
                  <input id="pagoFecha" type="date" />
                </label>
                <button class="btn btnTiny" id="btnAddPago" type="button">+ A√±adir pago</button>
              </div>
            </div>

            <div class="grid2">
              <label class="field">
                <span>M√©todo de pago</span>
                <select id="selMetodoPago">
                  <option value="efectivo">Efectivo</option>
                  <option value="transferencia">Transferencia</option>
                  <option value="tarjeta">Tarjeta</option>
                </select>
              </label>

              <label class="field">
                <span>Estado</span>
                <select id="selEstadoFactura">
                  <option value="impagada">Impagada</option>
                  <option value="parcial">Parcial</option>
                  <option value="pagada">Pagada</option>
                </select>
                <div class="hint small">El sistema recalcula pendiente seg√∫n pagos.</div>
              </label>
            </div>

            <div id="listaPagos" class="listBox" aria-label="Lista de pagos"></div>
          </div>
        </section>

      </section>

      <!-- =========================================================
      TAB: FACTURAS (listado + b√∫squeda)
      ========================================================== -->
      <section id="tabFacturas" class="tabPage" role="tabpanel" aria-label="Facturas">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Facturas</h1>
            <div class="muted">Listado ¬∑ b√∫squeda ¬∑ abrir para editar ¬∑ visor PDF interno</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn btnGhost" id="btnRefrescarFacturas" type="button">Refrescar</button>
          </div>
        </div>

        <div class="card">
          <div class="grid3">
            <label class="field">
              <span>Buscar</span>
              <input id="buscarFacturas" type="search" placeholder="N¬∫, cliente, tag, fecha..." />
            </label>
            <label class="field">
              <span>Desde</span>
              <input id="factDesde" type="date" />
            </label>
            <label class="field">
              <span>Hasta</span>
              <input id="factHasta" type="date" />
            </label>
          </div>
          <div id="listaFacturas" class="listBox" aria-label="Listado de facturas"></div>
        </div>
      </section>

      <!-- =========================================================
      TAB: CLIENTES
      ========================================================== -->
      <section id="tabClientes" class="tabPage" role="tabpanel" aria-label="Clientes">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Clientes</h1>
            <div class="muted">Gesti√≥n completa ¬∑ no borrar si est√° usado en facturas</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn" id="btnNuevoCliente" type="button">+ Nuevo cliente</button>
          </div>
        </div>

        <div class="card">
          <div class="grid2">
            <label class="field">
              <span>Buscar cliente</span>
              <input id="buscarClientes" type="search" placeholder="Nombre, NIF, alias..." />
            </label>
            <label class="field">
              <span>Acciones</span>
              <div class="row">
                <button class="btn btnGhost" id="btnExportClientes" type="button">Export</button>
                <button class="btn btnGhost" id="btnImportClientes" type="button">Import</button>
                <input id="fileImportClientes" type="file" accept="application/json" hidden />
              </div>
            </label>
          </div>

          <div class="split">
            <div class="splitLeft">
              <div id="listaClientes" class="listBox" aria-label="Listado de clientes"></div>
            </div>

            <div class="splitRight">
              <div class="editorHeader">
                <h2 class="h2">Ficha cliente</h2>
                <div class="miniRow">
                  <button class="btn btnTiny" id="btnGuardarCliente" type="button">Guardar</button>
                  <button class="btn btnTiny btnDangerGhost" id="btnEliminarCliente" type="button">Eliminar</button>
                </div>
              </div>

              <div class="grid2">
                <label class="field col2">
                  <span>Nombre fiscal</span>
                  <input id="cNombre" type="text" />
                </label>
                <label class="field col2">
                  <span>Alias / comercial</span>
                  <input id="cAlias" type="text" />
                </label>
                <label class="field">
                  <span>NIF/CIF</span>
                  <input id="cNif" type="text" />
                </label>
                <label class="field">
                  <span>M√©todo pago por defecto</span>
                  <select id="cPago">
                    <option value="">(sin definir)</option>
                    <option value="efectivo">Efectivo</option>
                    <option value="transferencia">Transferencia</option>
                    <option value="tarjeta">Tarjeta</option>
                  </select>
                </label>
                <label class="field col2">
                  <span>Direcci√≥n</span>
                  <input id="cDir" type="text" />
                </label>
                <label class="field">
                  <span>Tel√©fono</span>
                  <input id="cTel" type="text" />
                </label>
                <label class="field">
                  <span>Email</span>
                  <input id="cEmail" type="email" />
                </label>
                <label class="field col2">
                  <span>Notas</span>
                  <textarea id="cNotas" rows="4"></textarea>
                </label>
              </div>

              <div class="subCard">
                <div class="subCardTitle">Plantillas por cliente (recomendado)</div>
                <div class="grid3">
                  <label class="check">
                    <input id="cIvaIncluido" type="checkbox" />
                    <span>IVA incluido por defecto</span>
                  </label>
                  <label class="check">
                    <input id="cTransporte" type="checkbox" />
                    <span>Transporte por defecto</span>
                  </label>
                  <label class="field">
                    <span>Tags autom√°ticos</span>
                    <input id="cTagsAuto" type="text" placeholder="Ej: San Pablo, tienda..." />
                  </label>
                  <label class="field col3">
                    <span>Notas est√°ndar (auto en factura)</span>
                    <input id="cNotasStd" type="text" />
                  </label>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- =========================================================
      TAB: PRODUCTOS
      ========================================================== -->
      <section id="tabProductos" class="tabPage" role="tabpanel" aria-label="Productos">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Productos</h1>
            <div class="muted">Vocabulario + modos + precios + kg/caja + historial (solo pantalla)</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn" id="btnNuevoProducto" type="button">+ Nuevo producto</button>
          </div>
        </div>

        <div class="card">
          <div class="grid2">
            <label class="field">
              <span>Buscar producto</span>
              <input id="buscarProductos" type="search" placeholder="Nombre..." />
            </label>
            <label class="field">
              <span>Acciones</span>
              <div class="row">
                <button class="btn btnGhost" id="btnExportProductos" type="button">Export</button>
                <button class="btn btnGhost" id="btnImportProductos" type="button">Import</button>
                <input id="fileImportProductos" type="file" accept="application/json" hidden />
              </div>
            </label>
          </div>

          <div class="split">
            <div class="splitLeft">
              <div id="listaProductos" class="listBox" aria-label="Listado de productos"></div>
            </div>

            <div class="splitRight">
              <div class="editorHeader">
                <h2 class="h2">Ficha producto</h2>
                <div class="miniRow">
                  <button class="btn btnTiny" id="btnGuardarProducto" type="button">Guardar</button>
                  <button class="btn btnTiny btnDangerGhost" id="btnEliminarProducto" type="button">Eliminar</button>
                </div>
              </div>

              <div class="grid3">
                <label class="field col3">
                  <span>Nombre</span>
                  <input id="pNombre" type="text" />
                </label>

                <label class="field">
                  <span>Modo por defecto</span>
                  <select id="pModo">
                    <option value="kg">kg</option>
                    <option value="caja">caja</option>
                    <option value="ud">ud</option>
                  </select>
                </label>

                <label class="field">
                  <span>Kg por caja</span>
                  <input id="pKgCaja" type="number" inputmode="decimal" step="0.01" />
                </label>

                <label class="field">
                  <span>Precio ‚Ç¨/kg</span>
                  <input id="pPrecioKg" type="number" inputmode="decimal" step="0.01" />
                </label>
                <label class="field">
                  <span>Precio ‚Ç¨/caja</span>
                  <input id="pPrecioCaja" type="number" inputmode="decimal" step="0.01" />
                </label>
                <label class="field">
                  <span>Precio ‚Ç¨/ud</span>
                  <input id="pPrecioUd" type="number" inputmode="decimal" step="0.01" />
                </label>

                <label class="field">
                  <span>Coste</span>
                  <input id="pCoste" type="number" inputmode="decimal" step="0.01" />
                  <div class="hint small">Para margen en contabilidad (opcional).</div>
                </label>

                <label class="field col2">
                  <span>Origen por defecto</span>
                  <input id="pOrigen" type="text" />
                </label>

                <label class="field col3">
                  <span>Envase/Tara por defecto</span>
                  <select id="pTaraDefault">
                    <option value="">‚Äî Sin envase ‚Äî</option>
                  </select>
                  <div class="hint small">Se aplicar√° en la l√≠nea al elegir el producto (recomendado).</div>
                </label>
              </div>

              <div class="subCard">
                <div class="subCardTitle">Historial (solo pantalla)</div>
                <div id="pHistorial" class="historyBox" aria-label="Historial de precios"></div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- =========================================================
      TAB: TARAS
      ========================================================== -->
      <section id="tabTaras" class="tabPage" role="tabpanel" aria-label="Taras">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Taras</h1>
            <div class="muted">Envases/cajas con peso por unidad (kg) ¬∑ se aplica en modo KG restando al bruto</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn" id="btnNuevaTara" type="button">+ Nueva tara</button>
          </div>
        </div>

        <div class="card">
          <div class="grid2">
            <label class="field">
              <span>Buscar tara</span>
              <input id="buscarTaras" type="search" placeholder="Nombre..." />
            </label>
            <label class="field">
              <span>Acciones</span>
              <div class="row">
                <button class="btn btnGhost" id="btnExportTaras" type="button">Export</button>
                <button class="btn btnGhost" id="btnImportTaras" type="button">Import</button>
                <input id="fileImportTaras" type="file" accept="application/json" hidden />
              </div>
            </label>
          </div>

          <div class="split">
            <div class="splitLeft">
              <div id="listaTaras" class="listBox" aria-label="Listado de taras"></div>
            </div>

            <div class="splitRight">
              <div class="editorHeader">
                <h2 class="h2">Ficha tara</h2>
                <div class="miniRow">
                  <button class="btn btnTiny" id="btnGuardarTara" type="button">Guardar</button>
                  <button class="btn btnTiny btnDangerGhost" id="btnEliminarTara" type="button">Eliminar</button>
                </div>
              </div>

              <div class="grid2">
                <label class="field col2">
                  <span>Nombre</span>
                  <input id="tNombre" type="text" placeholder="Ej: Caja pl√°stico ESMO" />
                </label>
                <label class="field">
                  <span>Peso tara por unidad (kg)</span>
                  <input id="tPeso" type="number" inputmode="decimal" step="0.01" placeholder="0.30" />
                </label>
                <label class="field col2">
                  <span>Notas</span>
                  <textarea id="tNotas" rows="4"></textarea>
                </label>
              </div>

              <div class="hint">
                En factura: Tara total = N¬∫ envases √ó tara unidad. Si modo=caja, por defecto n¬∫ envases=cantidad.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- =========================================================
      TAB: CONTABILIDAD (PIN)
      ========================================================== -->
      <section id="tabContabilidad" class="tabPage tabProtected" role="tabpanel" aria-label="Contabilidad">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Contabilidad üîí</h1>
            <div class="muted">KPIs ¬∑ filtros ¬∑ pendientes ¬∑ export CSV/Excel</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn btnGhost" id="btnBloquearContabilidad" type="button">Bloquear</button>
          </div>
        </div>

        <div class="card">
          <div class="grid3">
            <label class="field">
              <span>Desde</span>
              <input id="contDesde" type="date" />
            </label>
            <label class="field">
              <span>Hasta</span>
              <input id="contHasta" type="date" />
            </label>
            <label class="field">
              <span>Cliente / Tag</span>
              <input id="contFiltro" type="text" placeholder="Cliente o tag..." />
            </label>
          </div>

          <div class="kpis">
            <div class="kpi"><div class="muted">Ventas</div><div class="kpiVal mono" id="kpiVentas">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">IVA</div><div class="kpiVal mono" id="kpiIva">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">N¬∫ facturas</div><div class="kpiVal mono" id="kpiNum">0</div></div>
            <div class="kpi"><div class="muted">Margen</div><div class="kpiVal mono" id="kpiMargen">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">Pendientes</div><div class="kpiVal mono" id="kpiPendientes">0,00 ‚Ç¨</div></div>
          </div>

          <div class="row">
            <button class="btn btnGhost" id="btnExportContCsv" type="button">Export CSV</button>
            <button class="btn btnGhost" id="btnExportContXls" type="button">Export Excel</button>
          </div>

          <div id="tablaContabilidad" class="listBox" aria-label="Resultados contabilidad"></div>
        </div>
      </section>

      <!-- =========================================================
      TAB: VENTAS (PIN)
      ========================================================== -->
      <section id="tabVentas" class="tabPage tabProtected" role="tabpanel" aria-label="Ventas">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Ventas diarias üîí</h1>
            <div class="muted">San Pablo ¬∑ San Lesmes ¬∑ Santiago ¬∑ efectivo + tarjeta + gastos ¬∑ reportes</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn btnGhost" id="btnBloquearVentas" type="button">Bloquear</button>
          </div>
        </div>

        <div class="card">
          <div class="grid3">
            <label class="field">
              <span>Tienda</span>
              <select id="vTienda">
                <option value="san_pablo">San Pablo</option>
                <option value="san_lesmes">San Lesmes</option>
                <option value="santiago">Santiago</option>
              </select>
            </label>
            <label class="field">
              <span>Fecha</span>
              <input id="vFecha" type="date" />
            </label>
            <label class="field">
              <span>D√≠a semana</span>
              <input id="vDiaSemana" type="text" disabled />
            </label>

            <label class="field">
              <span>Efectivo (‚Ç¨)</span>
              <input id="vEfectivo" type="number" inputmode="decimal" step="0.01" />
            </label>
            <label class="field">
              <span>Tarjeta (‚Ç¨)</span>
              <input id="vTarjeta" type="number" inputmode="decimal" step="0.01" />
            </label>
            <label class="field">
              <span>Gastos (‚Ç¨)</span>
              <input id="vGastos" type="number" inputmode="decimal" step="0.01" />
            </label>

            <label class="field col3">
              <span>Notas</span>
              <input id="vNotas" type="text" placeholder="Ej: cambio, incidencias, etc." />
            </label>
          </div>

          <div class="row">
            <button class="btn" id="btnGuardarVenta" type="button">Guardar venta</button>
            <button class="btn btnGhost" id="btnBorrarVenta" type="button">Eliminar d√≠a</button>
          </div>
        </div>

        <div class="card">
          <div class="cardTitleRow">
            <h2 class="h2">Reportes</h2>
            <div class="miniRow">
              <label class="fieldInline">
                <span>Desde</span>
                <input id="vRepDesde" type="date" />
              </label>
              <label class="fieldInline">
                <span>Hasta</span>
                <input id="vRepHasta" type="date" />
              </label>
              <button class="btn btnTiny" id="btnGenerarReporteVentas" type="button">Generar</button>
            </div>
          </div>

          <div class="kpis">
            <div class="kpi"><div class="muted">Total ventas</div><div class="kpiVal mono" id="vKpiTotal">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">Efectivo</div><div class="kpiVal mono" id="vKpiEf">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">Tarjeta</div><div class="kpiVal mono" id="vKpiTa">0,00 ‚Ç¨</div></div>
            <div class="kpi"><div class="muted">Gastos</div><div class="kpiVal mono" id="vKpiGa">0,00 ‚Ç¨</div></div>
          </div>

          <div class="row">
            <button class="btn btnGhost" id="btnReporteSemanal" type="button">Semanal</button>
            <button class="btn btnGhost" id="btnReporteMensual" type="button">Mensual</button>
            <button class="btn btnGhost" id="btnExportVentasCsv" type="button">Export CSV</button>
          </div>

          <div id="tablaVentas" class="listBox" aria-label="Tabla de ventas"></div>
        </div>
      </section>

      <!-- =========================================================
      TAB: AJUSTES
      ========================================================== -->
      <section id="tabAjustes" class="tabPage" role="tabpanel" aria-label="Ajustes">
        <div class="pageHeader">
          <div>
            <h1 class="h1">Ajustes</h1>
            <div class="muted">IVA ¬∑ transporte ¬∑ PIN ¬∑ plantilla QR ¬∑ Cloud Firebase opcional ¬∑ copias</div>
          </div>
          <div class="pageHeaderActions">
            <button class="btn btnGhost" id="btnBackupAll" type="button">Backup</button>
            <button class="btn btnGhost" id="btnRestoreAll" type="button">Restore</button>
            <input id="fileRestoreAll" type="file" accept="application/json" hidden />
          </div>
        </div>

        <div class="card">
          <div class="grid3">
            <label class="field">
              <span>IVA (%)</span>
              <input id="ajIva" type="number" inputmode="decimal" step="0.01" />
              <div class="hint small">Por defecto 4%.</div>
            </label>

            <label class="field">
              <span>Transporte (%)</span>
              <input id="ajTransporte" type="number" inputmode="decimal" step="0.01" />
              <div class="hint small">Solo aparece si activas ‚ÄúTransporte‚Äù en factura.</div>
            </label>

            <label class="field">
              <span>PIN (Contabilidad + Ventas)</span>
              <input id="ajPin" type="password" inputmode="numeric" />
              <div class="hint small">Por defecto 8410.</div>
            </label>

            <label class="field col3">
              <span>Plantilla QR (configurable)</span>
              <input id="ajQrPlantilla" type="text" spellcheck="false" />
              <div class="hint small">
                Ejemplo: NIF={NIF}&amp;NUM={NUM}&amp;FECHA={FECHA}&amp;TOTAL={TOTAL}
              </div>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="cardTitleRow">
            <h2 class="h2">Cloud Firebase (opcional)</h2>
            <div class="miniRow">
              <button class="btn btnTiny btnGhost" id="btnProbarCloud" type="button">Probar</button>
              <button class="btn btnTiny btnGhost" id="btnLoginCloud" type="button">Login</button>
              <button class="btn btnTiny btnGhost" id="btnLogoutCloud" type="button">Salir</button>
            </div>
          </div>

          <div class="grid3">
            <label class="field">
              <span>apiKey</span>
              <input id="fbApiKey" type="text" spellcheck="false" />
            </label>
            <label class="field">
              <span>authDomain</span>
              <input id="fbAuthDomain" type="text" spellcheck="false" />
            </label>
            <label class="field">
              <span>databaseURL</span>
              <input id="fbDatabaseURL" type="text" spellcheck="false" />
            </label>
            <label class="field">
              <span>projectId</span>
              <input id="fbProjectId" type="text" spellcheck="false" />
            </label>
            <label class="field">
              <span>appId</span>
              <input id="fbAppId" type="text" spellcheck="false" />
            </label>
            <label class="field">
              <span>storageBucket</span>
              <input id="fbStorageBucket" type="text" spellcheck="false" />
            </label>
          </div>

          <div class="hint">
            Si no configuras Cloud, el sistema funciona 100% local sin errores.
          </div>
        </div>

        <div class="card">
          <div class="cardTitleRow">
            <h2 class="h2">Diagn√≥stico</h2>
            <div class="miniRow">
              <button class="btn btnTiny btnGhost" id="btnResetDemo" type="button">Recargar defaults</button>
              <button class="btn btnTiny btnDangerGhost" id="btnHardReset" type="button">Reset total</button>
            </div>
          </div>
          <pre class="mono pre" id="diagBox">Cargando‚Ä¶</pre>
        </div>
      </section>

    </main>

    <!-- FOOTER -->
    <footer class="footer">
      <div class="muted small">
        FACTU MIRAL ¬∑ Offline primero ¬∑ B/W PRO ¬∑ ‚Äú√öltimos precios‚Äù solo en pantalla ¬∑ PDF PRO multip√°gina
      </div>
      <div class="muted small mono" id="buildInfo">v1.0</div>
    </footer>
  </div>

  <!-- =========================================================
  MODAL: PIN (para Contabilidad/Ventas)
  ========================================================== -->
  <div class="modal" id="pinModal" aria-hidden="true" role="dialog" aria-label="PIN">
    <div class="modalBackdrop" data-close="pin"></div>
    <div class="modalCard">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Acceso protegido üîí</div>
          <div class="muted small">Introduce el PIN para desbloquear Contabilidad/Ventas.</div>
        </div>
        <button class="btn btnTiny btnGhost" data-close="pin" type="button">Cerrar</button>
      </div>

      <div class="modalBody">
        <label class="field">
          <span>PIN</span>
          <input id="pinInput" type="password" inputmode="numeric" autocomplete="one-time-code" />
        </label>

        <div class="row">
          <button class="btn" id="btnPinOk" type="button">Desbloquear</button>
          <button class="btn btnGhost" id="btnPinCancel" data-close="pin" type="button">Cancelar</button>
        </div>

        <div class="hint small" id="pinMsg"></div>
      </div>
    </div>
  </div>

  <!-- =========================================================
  MODAL: PDF VIEWER (sin descargar)
  ========================================================== -->
  <div class="modal" id="pdfModal" aria-hidden="true" role="dialog" aria-label="Visor PDF">
    <div class="modalBackdrop" data-close="pdf"></div>
    <div class="modalCard modalPdf">
      <div class="modalHead">
        <div>
          <div class="modalTitle">Vista previa PDF</div>
          <div class="muted small">Ver sin descargar ¬∑ imprimir ¬∑ abrir en pesta√±a ¬∑ compartir</div>
        </div>
        <div class="miniRow">
          <button class="btn btnTiny btnGhost" id="btnPdfImprimir" type="button">Imprimir</button>
          <button class="btn btnTiny btnGhost" id="btnPdfPestana" type="button">Abrir pesta√±a</button>
          <button class="btn btnTiny btnGhost" id="btnPdfCompartir" type="button">Compartir</button>
          <button class="btn btnTiny btnGhost" data-close="pdf" type="button">Cerrar</button>
        </div>
      </div>

      <div class="modalBody modalPdfBody">
        <object id="pdfObject" type="application/pdf" data="" class="pdfObj">
          <iframe id="pdfFrame" class="pdfFrame" title="PDF"></iframe>
        </object>
        <div class="pdfEmpty" id="pdfEmpty">
          Genera un PDF para verlo aqu√≠.
        </div>
      </div>
    </div>
  </div>

  <!-- =========================================================
  TOAST / ALERTS
  ========================================================== -->
  <div class="toast" id="toast" aria-live="polite" aria-atomic="true"></div>

  <!-- =========================================================
  AUTOCOMPLETE POPUP (para Grid)
  ========================================================== -->
  <div id="acPopup" class="acPopup" aria-hidden="true"></div>
</body>
</html>
