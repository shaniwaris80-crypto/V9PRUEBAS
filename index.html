<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>ARSLAN ‚Ä¢ FACTURAS KIWI PRO (V3.0 Cloud PDF)</title>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jsPDF + AutoTable -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <div class="app">

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
      <div class="brand">
        <div class="kiwi-dot"></div>
        <div class="brand-text">
          <div class="brand-title">ARSLAN</div>
          <div class="brand-sub">FACTURAS ‚Ä¢ KIWI PRO</div>
        </div>
      </div>

      <nav class="nav">
        <button class="nav-item active" data-route="dashboard">
          <i data-lucide="layout-dashboard"></i><span>Dashboard</span>
        </button>
        <button class="nav-item" data-route="invoices">
          <i data-lucide="file-text"></i><span>Facturas</span>
        </button>
        <button class="nav-item" data-route="clients">
          <i data-lucide="users"></i><span>Clientes</span>
        </button>
        <button class="nav-item" data-route="reports">
          <i data-lucide="bar-chart-3"></i><span>Contabilidad</span>
        </button>
        <button class="nav-item" data-route="settings">
          <i data-lucide="settings"></i><span>Ajustes</span>
        </button>
      </nav>

      <div class="sidebar-footer">
        <div class="cloud-status" id="cloudStatus">
          <span class="dot gray" id="cloudDot"></span>
          <span class="cloud-text" id="cloudText">Local (sin nube)</span>
        </div>

        <div class="sidebar-mini">
          <button class="mini-btn" id="btnToggleTheme" title="Modo d√≠a/noche">
            <i data-lucide="moon"></i>
          </button>
          <button class="mini-btn" id="btnQuickBackup" title="Exportar backup JSON">
            <i data-lucide="download"></i>
          </button>
          <button class="mini-btn" id="btnQuickImport" title="Importar JSON">
            <i data-lucide="upload"></i>
          </button>
        </div>

        <div class="version">
          <span>V3.0</span> ¬∑ <span class="kiwi">Cloud PDF</span>
        </div>
      </div>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="topbar-left">
          <button class="hamburger" id="btnHamburger" aria-label="Men√∫">
            <i data-lucide="menu"></i>
          </button>
          <div class="page-title">
            <div class="title" id="pageTitle">Dashboard</div>
            <div class="subtitle" id="pageSubtitle">Resumen del negocio</div>
          </div>
        </div>

        <div class="topbar-right">
          <div class="searchbox">
            <i data-lucide="search"></i>
            <input id="globalSearch" type="text" placeholder="Buscar factura, cliente, n√∫mero‚Ä¶" autocomplete="off" />
          </div>

          <button class="btn primary" id="btnNewInvoice">
            <i data-lucide="plus"></i> Nueva factura
          </button>

          <button class="btn ghost" id="btnCloudLogin">
            <i data-lucide="cloud"></i> Nube
          </button>
        </div>
      </header>

      <!-- Content -->
      <section class="content">

        <!-- DASHBOARD -->
        <div class="view" id="view-dashboard">
          <div class="grid-kpis">
            <div class="card kpi">
              <div class="kpi-label">Hoy</div>
              <div class="kpi-value" id="kpiToday">0,00 ‚Ç¨</div>
              <div class="kpi-sub" id="kpiTodayCount">0 facturas</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Semana</div>
              <div class="kpi-value" id="kpiWeek">0,00 ‚Ç¨</div>
              <div class="kpi-sub" id="kpiWeekCount">0 facturas</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Mes</div>
              <div class="kpi-value" id="kpiMonth">0,00 ‚Ç¨</div>
              <div class="kpi-sub" id="kpiMonthCount">0 facturas</div>
            </div>
            <div class="card kpi">
              <div class="kpi-label">Pendiente</div>
              <div class="kpi-value" id="kpiPending">0,00 ‚Ç¨</div>
              <div class="kpi-sub" id="kpiPendingCount">0 facturas</div>
            </div>
          </div>

          <div class="grid-two">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Evoluci√≥n (√∫ltimos 30 d√≠as)</div>
                <div class="card-actions">
                  <button class="btn tiny" id="btnRefreshChart"><i data-lucide="refresh-cw"></i></button>
                </div>
              </div>
              <div class="card-body">
                <canvas id="chart30"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Top clientes (mes actual)</div>
              </div>
              <div class="card-body">
                <div class="list" id="topClients"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- INVOICES -->
        <div class="view hidden" id="view-invoices">
          <div class="toolbar">
            <div class="chips">
              <button class="chip active" data-filter="all">Todas</button>
              <button class="chip" data-filter="pending">Pendientes</button>
              <button class="chip" data-filter="paid">Pagadas</button>
              <button class="chip" data-filter="today">Hoy</button>
              <button class="chip" data-filter="month">Mes</button>
            </div>

            <div class="toolbar-right">
              <select id="filterTag" class="select">
                <option value="">Todos los tags</option>
              </select>
              <button class="btn" id="btnExportInvoicesCSV">
                <i data-lucide="file-down"></i> Export CSV
              </button>
            </div>
          </div>

          <div class="card">
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>Fecha</th>
                    <th>N¬∫</th>
                    <th>Cliente</th>
                    <th>Tag</th>
                    <th>Importe</th>
                    <th>Estado</th>
                    <th style="width:240px">Acciones</th>
                  </tr>
                </thead>
                <tbody id="invoiceTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- CLIENTS -->
        <div class="view hidden" id="view-clients">
          <div class="toolbar">
            <div class="toolbar-left">
              <button class="btn primary" id="btnNewClient">
                <i data-lucide="user-plus"></i> Nuevo cliente
              </button>
            </div>
          </div>

          <div class="card">
            <div class="table-wrap">
              <table class="table">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>NIF</th>
                    <th>Tags</th>
                    <th>Total acumulado</th>
                    <th style="width:220px">Acciones</th>
                  </tr>
                </thead>
                <tbody id="clientTable"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- REPORTS -->
        <div class="view hidden" id="view-reports">
          <div class="grid-two">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Ingresos por mes (√∫ltimos 12)</div>
              </div>
              <div class="card-body">
                <canvas id="chartMonths"></canvas>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Ranking por clientes (rango)</div>
              </div>
              <div class="card-body">
                <div class="row two">
                  <div>
                    <label class="label">Desde</label>
                    <input type="date" id="repFrom" class="input" />
                  </div>
                  <div>
                    <label class="label">Hasta</label>
                    <input type="date" id="repTo" class="input" />
                  </div>
                </div>
                <button class="btn primary full" id="btnRunReport">
                  <i data-lucide="sparkles"></i> Generar reporte
                </button>
                <div class="list mt" id="rankClients"></div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Totales por Tag (rango)</div>
            </div>
            <div class="card-body">
              <div class="list" id="rankTags"></div>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div class="view hidden" id="view-settings">
          <div class="grid-two">
            <div class="card">
              <div class="card-header">
                <div class="card-title">Nube (Firebase)</div>
              </div>
              <div class="card-body">
                <div class="row">
                  <label class="switch">
                    <input type="checkbox" id="toggleCloud" />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="strong">Activar Nube</div>
                    <div class="muted">Guarda y sincroniza datos + PDFs</div>
                  </div>
                </div>

                <div class="row">
                  <label class="switch">
                    <input type="checkbox" id="toggleAutoPDF" checked />
                    <span class="slider"></span>
                  </label>
                  <div>
                    <div class="strong">Auto-subir PDF</div>
                    <div class="muted">Al crear/editar factura, sube el PDF autom√°ticamente</div>
                  </div>
                </div>

                <div class="row gap">
                  <button class="btn" id="btnForceSync"><i data-lucide="refresh-cw"></i> Forzar Sync</button>
                  <button class="btn" id="btnCloudLogout"><i data-lucide="log-out"></i> Cerrar sesi√≥n nube</button>
                </div>

                <div class="note">
                  üí° Para usar nube: pega tu Firebase config en <b>app.js</b>.
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <div class="card-title">Backups</div>
              </div>
              <div class="card-body">
                <button class="btn full" id="btnExportJSON"><i data-lucide="download"></i> Exportar JSON</button>
                <button class="btn full" id="btnImportJSON"><i data-lucide="upload"></i> Importar JSON</button>
                <input type="file" id="fileImport" accept="application/json" class="hidden" />
                <div class="note">
                  ‚úÖ Importar hace <b>merge inteligente</b> y evita duplicados.
                </div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card-header">
              <div class="card-title">Atajos</div>
            </div>
            <div class="card-body">
              <div class="kbd-grid">
                <div class="kbd-item"><span>Ctrl + N</span><small>Nueva factura</small></div>
                <div class="kbd-item"><span>Ctrl + S</span><small>Guardar factura (en editor)</small></div>
                <div class="kbd-item"><span>Esc</span><small>Cerrar modales</small></div>
              </div>
            </div>
          </div>
        </div>

      </section>

      <!-- Mobile Bottom Tabs -->
      <div class="mobile-tabs" id="mobileTabs">
        <button class="tab active" data-route="dashboard"><i data-lucide="layout-dashboard"></i></button>
        <button class="tab" data-route="invoices"><i data-lucide="file-text"></i></button>
        <button class="tab" data-route="clients"><i data-lucide="users"></i></button>
        <button class="tab" data-route="reports"><i data-lucide="bar-chart-3"></i></button>
        <button class="tab" data-route="settings"><i data-lucide="settings"></i></button>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div class="toast-wrap" id="toastWrap"></div>

  <!-- MODAL: Cloud Login -->
  <div class="modal hidden" id="modalCloud">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title">‚òÅÔ∏è Iniciar sesi√≥n en la nube</div>
        <button class="icon-btn" data-close="modalCloud"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <div class="note">
          ‚úÖ Nube guarda: clientes, facturas y PDFs. <br>
          ‚úÖ Al entrar sincroniza y podr√°s abrir PDFs hist√≥ricos.
        </div>

        <label class="label">Email</label>
        <input class="input" id="cloudEmail" type="email" placeholder="tuemail@gmail.com" />

        <label class="label">Password</label>
        <input class="input" id="cloudPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />

        <div class="row gap">
          <button class="btn primary full" id="btnCloudSignIn">
            <i data-lucide="log-in"></i> Entrar
          </button>
          <button class="btn full" id="btnCloudRegister">
            <i data-lucide="user-plus"></i> Crear cuenta
          </button>
        </div>

        <div class="muted small">
          Si ya tienes tu sistema con usuarios internos por PIN, aqu√≠ solo es login para nube.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Invoice Editor -->
  <div class="modal hidden" id="modalInvoice">
    <div class="modal-card big">
      <div class="modal-head">
        <div class="modal-title" id="invModalTitle">üßæ Nueva factura</div>
        <button class="icon-btn" data-close="modalInvoice"><i data-lucide="x"></i></button>
      </div>

      <div class="modal-body">
        <div class="row two">
          <div>
            <label class="label">Fecha</label>
            <input type="date" class="input" id="invDate" />
          </div>
          <div>
            <label class="label">N√∫mero</label>
            <input type="text" class="input" id="invNumber" placeholder="FA-YYYYMMDDHHMM" />
          </div>
        </div>

        <label class="label">Cliente</label>
        <select class="select" id="invClient"></select>

        <label class="label">Tag (opcional)</label>
        <select class="select" id="invTag">
          <option value="">‚Äî Sin tag ‚Äî</option>
        </select>

        <label class="label">Estado</label>
        <select class="select" id="invStatus">
          <option value="PENDIENTE">PENDIENTE</option>
          <option value="PAGADO">PAGADO</option>
        </select>

        <div class="row two mt">
          <div>
            <label class="label">Importe (‚Ç¨)</label>
            <input type="number" step="0.01" class="input" id="invAmount" placeholder="0.00" />
          </div>
          <div>
            <label class="label">Notas</label>
            <input type="text" class="input" id="invNotes" placeholder="Observaciones..." />
          </div>
        </div>

        <div class="row gap mt">
          <button class="btn" id="btnInvPDFLocal"><i data-lucide="file-down"></i> PDF (Local)</button>
          <button class="btn" id="btnInvPDFCloud"><i data-lucide="cloud-upload"></i> PDF + Nube</button>
          <button class="btn ghost" id="btnInvViewPDF" disabled><i data-lucide="eye"></i> Ver PDF</button>
        </div>

        <div class="divider"></div>

        <div class="row gap">
          <button class="btn primary full" id="btnInvSave">
            <i data-lucide="save"></i> Guardar factura
          </button>
          <button class="btn full" id="btnInvDuplicate">
            <i data-lucide="copy"></i> Duplicar
          </button>
        </div>

        <div class="note">
          ‚úÖ Guardar actualiza Gesti√≥n + Contabilidad. Si nube ON + AutoPDF ON ‚Üí se sube PDF autom√°ticamente.
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: Client Editor -->
  <div class="modal hidden" id="modalClient">
    <div class="modal-card">
      <div class="modal-head">
        <div class="modal-title" id="cliModalTitle">üë§ Nuevo cliente</div>
        <button class="icon-btn" data-close="modalClient"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <label class="label">Nombre</label>
        <input class="input" id="cliName" type="text" placeholder="RIVIERA" />

        <label class="label">NIF</label>
        <input class="input" id="cliNIF" type="text" placeholder="B12345678" />

        <label class="label">Tags (separados por coma)</label>
        <input class="input" id="cliTags" type="text" placeholder="Centro, Severo, Edificio" />

        <div class="row gap mt">
          <button class="btn primary full" id="btnCliSave"><i data-lucide="save"></i> Guardar</button>
          <button class="btn danger full" id="btnCliDelete"><i data-lucide="trash-2"></i> Eliminar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: PDF Viewer -->
  <div class="modal hidden" id="modalPDF">
    <div class="modal-card big">
      <div class="modal-head">
        <div class="modal-title">üìÑ PDF Factura</div>
        <button class="icon-btn" data-close="modalPDF"><i data-lucide="x"></i></button>
      </div>
      <div class="modal-body">
        <iframe id="pdfFrame" class="pdf-frame" src=""></iframe>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
