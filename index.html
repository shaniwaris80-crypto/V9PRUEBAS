<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>ARSLAN • FACTURAS — KIWI EDITION</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="./style.css" />

  <!-- Optional libs (si no cargan, el sistema sigue funcionando en modo local sin PDF/QR) -->
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/lz-string/1.5.0/lz-string.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

  <script type="module" src="./app.js"></script>
</head>

<body>
  <div class="app">

    <!-- TOPBAR -->
    <header class="topbar">
      <div class="brand">
        <div class="brand__mark">KIWI</div>
        <div class="brand__text">
          <div class="brand__title">ARSLAN • FACTURAS</div>
          <div class="brand__sub">KIWI EDITION — B/W • Offline-first • Cloud opcional</div>
        </div>
      </div>

      <div class="topbar__right">
        <div class="chip" id="chipMode">Modo local</div>
        <button class="btn btn--ghost" id="btnSyncNow" title="Sync ahora (si hay login)">Sync ahora</button>
        <button class="btn" id="btnNewInvoice">+ Nueva factura</button>
      </div>
    </header>

    <!-- NAV -->
    <nav class="tabs" role="tablist" aria-label="Secciones">
      <button class="tab is-active" data-tab="invoices">Facturas</button>
      <button class="tab" data-tab="clients">Clientes</button>
      <button class="tab" data-tab="products">Productos</button>
      <button class="tab" data-tab="accounting">Contabilidad</button>
      <button class="tab" data-tab="settings">Ajustes</button>
    </nav>

    <!-- CONTENT -->
    <main class="content">

      <!-- ROUTE: PRICE MODE (link externo dentro del mismo archivo) -->
      <section class="page hidden" id="pagePrices">
        <div class="page__head">
          <div>
            <h2>Precios externos</h2>
            <p class="muted">Cuadrícula rápida para móvil. Guarda y exporta precios para importar en la app principal.</p>
          </div>
          <div class="page__headRight">
            <button class="btn btn--ghost" id="btnPricesBack">← Volver</button>
            <button class="btn" id="btnPricesExport">Exportar precios (link/JSON)</button>
          </div>
        </div>

        <div class="card">
          <div class="card__row">
            <div class="field">
              <label>Buscar producto</label>
              <input id="pricesSearch" type="text" placeholder="Escribe para filtrar..." />
            </div>
            <div class="field">
              <label>Modo</label>
              <select id="pricesMode">
                <option value="all">Todos</option>
                <option value="kg">Kg</option>
                <option value="caja">Caja</option>
                <option value="ud">Unidad</option>
              </select>
            </div>
            <div class="field">
              <label>Atajo</label>
              <div class="hint">Enter = siguiente precio</div>
            </div>
          </div>

          <div class="tableWrap">
            <table class="table" id="pricesTable">
              <thead>
                <tr>
                  <th>Producto</th>
                  <th class="w120">Unidad</th>
                  <th class="w140">Kg/Caja</th>
                  <th class="w160">Precio</th>
                  <th class="w120">Coste</th>
                  <th class="w160">Origen</th>
                </tr>
              </thead>
              <tbody id="pricesTbody"></tbody>
            </table>
          </div>

          <div class="footNote">
            <span class="muted">Nota: Esto actualiza el catálogo de productos (precio/coste/origen). No toca facturas ya cerradas.</span>
          </div>
        </div>
      </section>

      <!-- INVOICES -->
      <section class="page" id="pageInvoices">
        <div class="split">

          <!-- LIST -->
          <aside class="panel panel--list">
            <div class="panel__head">
              <h2>Facturas</h2>
              <div class="panel__actions">
                <button class="btn btn--ghost" id="btnExportWhatsAppAll" title="Exportar listado filtrado (texto)">WhatsApp</button>
                <button class="btn btn--ghost" id="btnBackup">Export JSON</button>
                <label class="btn btn--ghost fileBtn">
                  Import JSON
                  <input type="file" id="fileImport" accept="application/json" />
                </label>
              </div>
            </div>

            <div class="panel__filters">
              <input id="invSearch" type="text" placeholder="Buscar: número / cliente / tag..." />
              <select id="invStatus">
                <option value="all">Todos</option>
                <option value="unpaid">Impagada</option>
                <option value="partial">Parcial</option>
                <option value="paid">Pagada</option>
                <option value="draft">Borrador</option>
                <option value="closed">Cerrada</option>
                <option value="void">Anulada</option>
              </select>
            </div>

            <div class="list" id="invList"></div>
          </aside>

          <!-- EDITOR -->
          <section class="panel panel--editor">
            <div class="editorHead">
              <div class="editorHead__left">
                <h2 id="editorTitle">Editor</h2>
                <div class="muted" id="editorSub">Selecciona una factura o crea una nueva.</div>
              </div>
              <div class="editorHead__right">
                <button class="btn btn--ghost" id="btnDuplicate">Duplicar</button>
                <button class="btn btn--ghost" id="btnDelete">Eliminar</button>
                <button class="btn" id="btnSaveInvoice">Guardar</button>
              </div>
            </div>

            <div class="card">
              <div class="invoiceHeader">
                <div class="box">
                  <div class="box__title">Proveedor</div>
                  <div class="grid2">
                    <div class="field">
                      <label>Nombre</label>
                      <input id="provName" type="text" />
                    </div>
                    <div class="field">
                      <label>NIF</label>
                      <input id="provNif" type="text" />
                    </div>
                    <div class="field">
                      <label>Dirección</label>
                      <input id="provAddr" type="text" />
                    </div>
                    <div class="field">
                      <label>Teléfono</label>
                      <input id="provPhone" type="text" />
                    </div>
                    <div class="field span2">
                      <label>Email</label>
                      <input id="provEmail" type="email" />
                    </div>
                  </div>
                </div>

                <div class="qrBox">
                  <div class="box__title center">QR AEAT</div>
                  <div id="qrWrap" class="qrWrap">
                    <div class="qrFallback muted">QR no disponible (librería no cargada)</div>
                  </div>
                  <div class="mini muted" id="qrTextMini"></div>
                </div>

                <div class="box">
                  <div class="box__title">Cliente</div>

                  <div class="grid2">
                    <div class="field span2">
                      <label>Seleccionar</label>
                      <select id="invClient"></select>
                    </div>

                    <div class="field">
                      <label>Nombre fiscal</label>
                      <input id="cliFiscal" type="text" readonly />
                    </div>
                    <div class="field">
                      <label>Alias</label>
                      <input id="cliAlias" type="text" readonly />
                    </div>

                    <div class="field">
                      <label>NIF/CIF</label>
                      <input id="cliNif" type="text" readonly />
                    </div>
                    <div class="field">
                      <label>Teléfono</label>
                      <input id="cliPhone" type="text" readonly />
                    </div>

                    <div class="field span2">
                      <label>Dirección</label>
                      <input id="cliAddr" type="text" readonly />
                    </div>

                    <div class="field span2">
                      <label>Email</label>
                      <input id="cliEmail" type="email" readonly />
                    </div>
                  </div>

                </div>
              </div>

              <div class="invoiceMeta">
                <div class="field">
                  <label>Nº factura</label>
                  <input id="invNumber" type="text" readonly />
                </div>
                <div class="field">
                  <label>Fecha</label>
                  <input id="invDate" type="date" />
                </div>
                <div class="field">
                  <label>Tags</label>
                  <input id="invTags" type="text" placeholder="ej: Centro, Restaurante, ..." />
                </div>
                <div class="field">
                  <label>Estado</label>
                  <select id="invLifeState">
                    <option value="draft">Borrador</option>
                    <option value="closed">Cerrada</option>
                    <option value="void">Anulada</option>
                  </select>
                </div>
              </div>

              <div class="invoiceMeta2">
                <div class="field">
                  <label>Método</label>
                  <select id="invMethod">
                    <option value="Efectivo">Efectivo</option>
                    <option value="Transferencia">Transferencia</option>
                    <option value="Tarjeta">Tarjeta</option>
                  </select>
                </div>

                <div class="field">
                  <label>IVA</label>
                  <select id="invVatMode">
                    <option value="split">Desglosado</option>
                    <option value="included">Incluido en precios</option>
                  </select>
                </div>

                <div class="field">
                  <label>IVA %</label>
                  <input id="invVatRate" type="number" step="0.01" min="0" />
                </div>

                <div class="field">
                  <label>Transporte %</label>
                  <input id="invTransportPct" type="number" step="0.01" min="0" />
                </div>

                <div class="field">
                  <label>PDF</label>
                  <div class="rowBtns">
                    <button class="btn btn--ghost" id="btnPdf">Generar</button>
                    <button class="btn btn--ghost" id="btnOpenPdf">Abrir</button>
                    <button class="btn btn--ghost" id="btnCopyPdf">Copiar link</button>
                  </div>
                </div>

                <div class="field">
                  <label>WhatsApp</label>
                  <div class="rowBtns">
                    <button class="btn btn--ghost" id="btnWhatsApp">Texto</button>
                    <button class="btn btn--ghost" id="btnCopyWhatsApp">Copiar</button>
                  </div>
                </div>
              </div>

              <div class="gridTools">
                <div class="gridTools__left">
                  <button class="btn btn--ghost" id="btnAddLine">+ Añadir línea</button>
                  <button class="btn btn--ghost" id="btnClearLines">Vaciar</button>
                </div>
                <div class="gridTools__right muted mini">
                  Enter → siguiente campo · Al final: crea/salta a la siguiente línea · Hint precios solo pantalla
                </div>
              </div>

              <div class="tableWrap">
                <table class="table table--grid" id="linesTable">
                  <thead>
                    <tr>
                      <th>Producto</th>
                      <th class="w110">Modo</th>
                      <th class="w90">Cant</th>
                      <th class="w90">Bruto</th>
                      <th class="w90">Tara</th>
                      <th class="w90">Neto</th>
                      <th class="w110">Precio</th>
                      <th class="w120">Origen</th>
                      <th class="w110 right">Importe</th>
                      <th class="w60 center">X</th>
                    </tr>
                  </thead>
                  <tbody id="linesTbody"></tbody>
                </table>
              </div>

              <!-- Totals + Payments + Notes -->
              <div class="below">

                <div class="card miniCard">
                  <div class="card__title">Totales</div>
                  <div class="kpis">
                    <div class="kpi">
                      <div class="kpi__label">Subtotal</div>
                      <div class="kpi__value" id="kSubtotal">0,00 €</div>
                    </div>
                    <div class="kpi">
                      <div class="kpi__label">Transporte</div>
                      <div class="kpi__value" id="kTransport">0,00 €</div>
                    </div>
                    <div class="kpi">
                      <div class="kpi__label">IVA</div>
                      <div class="kpi__value" id="kVat">0,00 €</div>
                    </div>
                    <div class="kpi">
                      <div class="kpi__label">Total</div>
                      <div class="kpi__value" id="kTotal">0,00 €</div>
                    </div>
                    <div class="kpi">
                      <div class="kpi__label">Pagado</div>
                      <div class="kpi__value" id="kPaid">0,00 €</div>
                    </div>
                    <div class="kpi">
                      <div class="kpi__label">Pendiente</div>
                      <div class="kpi__value" id="kDue">0,00 €</div>
                    </div>
                  </div>
                </div>

                <div class="card miniCard">
                  <div class="card__title">Pagos</div>
                  <div class="payRow">
                    <input id="payAmount" type="number" step="0.01" min="0" placeholder="Importe" />
                    <button class="btn btn--ghost" id="btnAddPayment">Añadir pago</button>
                    <button class="btn btn--ghost" id="btnMarkPaid">Marcar pagada</button>
                  </div>
                  <div class="listSmall" id="payList"></div>
                </div>

                <div class="card miniCard">
                  <div class="card__title">Notas</div>
                  <textarea id="invNotes" rows="6" placeholder="Observaciones..."></textarea>
                </div>

              </div>

              <div class="footNote">
                <span class="muted" id="pdfHint">PDF/QR dependen de librerías externas. Si no cargan, el sistema sigue funcionando.</span>
              </div>
            </div>
          </section>

        </div>
      </section>

      <!-- CLIENTS -->
      <section class="page hidden" id="pageClients">
        <div class="page__head">
          <div>
            <h2>Clientes</h2>
            <p class="muted">Alta / edición / borrado. Selector automático en facturas.</p>
          </div>
          <div class="page__headRight">
            <input id="cliSearch" type="text" placeholder="Buscar cliente..." />
            <button class="btn" id="btnAddClient">+ Nuevo cliente</button>
          </div>
        </div>

        <div class="card">
          <div class="tableWrap">
            <table class="table" id="clientsTable">
              <thead>
                <tr>
                  <th>Fiscal</th>
                  <th>Alias</th>
                  <th>NIF/CIF</th>
                  <th>Teléfono</th>
                  <th>Email</th>
                  <th>IVA</th>
                  <th class="w220">Tags</th>
                  <th class="w160">Acciones</th>
                </tr>
              </thead>
              <tbody id="clientsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- PRODUCTS -->
      <section class="page hidden" id="pageProducts">
        <div class="page__head">
          <div>
            <h2>Productos</h2>
            <p class="muted">Catálogo + precios + historial (solo pantalla). Autocomplete en facturas.</p>
          </div>
          <div class="page__headRight">
            <input id="prodSearch" type="text" placeholder="Buscar producto..." />
            <button class="btn btn--ghost" id="btnOpenPricesMode">Abrir “poner precios”</button>
            <button class="btn" id="btnAddProduct">+ Nuevo producto</button>
          </div>
        </div>

        <div class="card">
          <div class="tableWrap">
            <table class="table" id="productsTable">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th class="w120">Unidad</th>
                  <th class="w120">Kg/Caja</th>
                  <th class="w120">Precio</th>
                  <th class="w120">Coste</th>
                  <th class="w180">Origen</th>
                  <th class="w220">Historial (últimos 5)</th>
                  <th class="w160">Acciones</th>
                </tr>
              </thead>
              <tbody id="productsTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ACCOUNTING -->
      <section class="page hidden" id="pageAccounting">
        <div class="page__head">
          <div>
            <h2>Contabilidad</h2>
            <p class="muted">Protegida con PIN. Filtros, KPIs, detalle y export CSV.</p>
          </div>
          <div class="page__headRight">
            <button class="btn btn--ghost" id="btnLockAccounting">Bloquear</button>
            <button class="btn" id="btnExportCSV">Export CSV</button>
          </div>
        </div>

        <div class="card" id="accLockCard">
          <div class="lock">
            <div class="lock__title">Bloqueado</div>
            <div class="lock__sub muted">Introduce el PIN para ver contabilidad.</div>
            <div class="lock__row">
              <input id="accPin" type="password" inputmode="numeric" placeholder="PIN" />
              <button class="btn" id="btnUnlockAccounting">Desbloquear</button>
            </div>
            <div class="muted mini">PIN por defecto: 7392 (cámbialo en Ajustes).</div>
          </div>
        </div>

        <div class="card hidden" id="accMainCard">
          <div class="card__row">
            <div class="field">
              <label>Desde</label>
              <input id="accFrom" type="date" />
            </div>
            <div class="field">
              <label>Hasta</label>
              <input id="accTo" type="date" />
            </div>
            <div class="field">
              <label>Cliente</label>
              <select id="accClient"></select>
            </div>
            <div class="field">
              <label>Tag</label>
              <input id="accTag" type="text" placeholder="ej: Centro" />
            </div>
            <div class="field">
              <label>Aplicar</label>
              <button class="btn btn--ghost" id="btnAccApply">Filtrar</button>
            </div>
          </div>

          <div class="kpis kpis--big">
            <div class="kpi">
              <div class="kpi__label">Ventas</div>
              <div class="kpi__value" id="aSales">0,00 €</div>
            </div>
            <div class="kpi">
              <div class="kpi__label">IVA</div>
              <div class="kpi__value" id="aVat">0,00 €</div>
            </div>
            <div class="kpi">
              <div class="kpi__label">Nº facturas</div>
              <div class="kpi__value" id="aCount">0</div>
            </div>
            <div class="kpi">
              <div class="kpi__label">Margen estimado</div>
              <div class="kpi__value" id="aMargin">0,00 €</div>
            </div>
            <div class="kpi">
              <div class="kpi__label">Pendiente</div>
              <div class="kpi__value" id="aDue">0,00 €</div>
            </div>
          </div>

          <div class="tableWrap">
            <table class="table" id="accTable">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Nº</th>
                  <th>Cliente</th>
                  <th>Tags</th>
                  <th class="right">Total</th>
                  <th>Estado</th>
                  <th class="right">Pendiente</th>
                </tr>
              </thead>
              <tbody id="accTbody"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section class="page hidden" id="pageSettings">
        <div class="page__head">
          <div>
            <h2>Ajustes</h2>
            <p class="muted">Proveedor, IVA, transporte, QR, PIN, nube y herramientas.</p>
          </div>
          <div class="page__headRight">
            <button class="btn btn--ghost" id="btnReset" title="Borra datos locales (con confirmación)">Reset</button>
            <button class="btn" id="btnSaveSettings">Guardar ajustes</button>
          </div>
        </div>

        <div class="grid2col">

          <div class="card">
            <div class="card__title">Proveedor por defecto</div>
            <div class="grid2">
              <div class="field">
                <label>Nombre</label>
                <input id="sProvName" type="text" />
              </div>
              <div class="field">
                <label>NIF</label>
                <input id="sProvNif" type="text" />
              </div>
              <div class="field span2">
                <label>Dirección</label>
                <input id="sProvAddr" type="text" />
              </div>
              <div class="field">
                <label>Teléfono</label>
                <input id="sProvPhone" type="text" />
              </div>
              <div class="field">
                <label>Email</label>
                <input id="sProvEmail" type="email" />
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__title">Impuestos / Transporte / QR</div>
            <div class="grid2">
              <div class="field">
                <label>IVA %</label>
                <input id="sVatRate" type="number" step="0.01" min="0" />
              </div>
              <div class="field">
                <label>IVA modo</label>
                <select id="sVatMode">
                  <option value="split">Desglosado</option>
                  <option value="included">Incluido</option>
                </select>
              </div>
              <div class="field">
                <label>Transporte %</label>
                <input id="sTransportPct" type="number" step="0.01" min="0" />
              </div>
              <div class="field">
                <label>PIN contabilidad</label>
                <input id="sAccPin" type="password" inputmode="numeric" />
              </div>

              <div class="field span2">
                <label>Plantilla QR (tokens: {NIF} {NUM} {FECHA} {TOTAL})</label>
                <input id="sQrTpl" type="text" />
                <div class="mini muted">Ej: AEAT|NIF={NIF}|NUM={NUM}|FECHA={FECHA}|TOTAL={TOTAL}</div>
              </div>
            </div>
          </div>

          <div class="card">
            <div class="card__title">Nube Firebase (opcional)</div>
            <div class="grid2">
              <div class="field span2">
                <label>Root key (ruta base DB)</label>
                <input id="sCloudRoot" type="text" placeholder="arslan_facturas_kiwi" />
              </div>
              <div class="field span2">
                <label>firebaseConfig (JSON)</label>
                <textarea id="sFirebaseConfig" rows="6" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"...","storageBucket":"...","appId":"..."}'></textarea>
              </div>

              <div class="field">
                <label>Auto-sync</label>
                <select id="sAutoSync">
                  <option value="off">Off</option>
                  <option value="on">On</option>
                </select>
              </div>

              <div class="field">
                <label>Precios: importar al sync</label>
                <select id="sSyncPrices">
                  <option value="on">On</option>
                  <option value="off">Off</option>
                </select>
              </div>
            </div>

            <div class="card__row">
              <div class="field">
                <label>Email</label>
                <input id="authEmail" type="email" placeholder="email" />
              </div>
              <div class="field">
                <label>Password</label>
                <input id="authPass" type="password" placeholder="password" />
              </div>
              <div class="field">
                <label>Acción</label>
                <div class="rowBtns">
                  <button class="btn btn--ghost" id="btnSignup">Signup</button>
                  <button class="btn btn--ghost" id="btnLogin">Login</button>
                  <button class="btn btn--ghost" id="btnLogout">Logout</button>
                </div>
              </div>
            </div>

            <div class="muted mini" id="cloudStatus">Cloud: no configurado</div>
          </div>

          <div class="card">
            <div class="card__title">Herramientas</div>
            <div class="tools">
              <button class="btn btn--ghost" id="btnImportPrices">Importar precios (link/JSON)</button>
              <button class="btn btn--ghost" id="btnGenPricesLink">Generar link “poner precios”</button>
              <button class="btn btn--ghost" id="btnRebuildIndexes">Reparar datos</button>
            </div>
            <div class="mini muted" style="margin-top:10px">
              “Poner precios” se abre en este mismo archivo con <code>?mode=prices</code>. Puedes compartir ese link.
            </div>
          </div>

        </div>
      </section>

    </main>

    <!-- AUTOCOMPLETE BOX -->
    <div id="acBox" class="ac hidden"></div>

    <!-- MODAL -->
    <div class="modal hidden" id="modal">
      <div class="modal__panel">
        <div class="modal__title" id="modalTitle">Título</div>
        <div class="modal__body" id="modalBody">Contenido</div>
        <div class="modal__actions" id="modalActions"></div>
      </div>
    </div>

  </div>
</body>
</html>
